<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presidentes da América do Sul</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PeerJS for Multiplayer -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: { 400: '#FACC15', 500: '#EAB308', 600: '#CA8A04' },
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        presidential: { blue: '#1e3a8a', red: '#991b1b', green: '#166534' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(16px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .country-path { transition: all 0.3s ease; cursor: pointer; stroke-width: 1.5; }
        .country-path:hover { filter: brightness(1.1); transform: scale(1.01); transform-origin: center; z-index: 10; }
        .news-item { border-left: 4px solid; }
        .news-real { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .news-fake { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        .news-rumor { border-color: #eab308; background: rgba(234, 179, 8, 0.1); }
        .gov-card { transition: all 0.2s; }
        .gov-card:active { transform: scale(0.98); border-color: #EAB308; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- Top Bar -->
    <header id="game-header" class="h-16 flex items-center justify-between px-4 glass-panel z-20 shrink-0 hidden border-b border-slate-700">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center border border-slate-500">
                <i data-lucide="flag" class="w-4 h-4 text-white"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase leading-none">Presidente</span>
                <span class="font-bold text-sm text-white leading-tight truncate w-24" id="header-country">País</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Semestre</span>
                <span class="text-xl font-bold text-gold-500" id="round-display">1/8</span>
            </div>
            <button onclick="Game.exitGame()" class="w-8 h-8 rounded bg-red-900/50 flex items-center justify-center text-red-300 border border-red-800 active:scale-95">
                <i data-lucide="log-out" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="flex-1 overflow-y-auto scroll-hide relative pb-24">
        <!-- Views injected by JS -->
    </main>

    <!-- Government Selection Overlay (Start Game) -->
    <div id="setup-overlay" class="fixed inset-0 bg-dark-900 z-[80] hidden flex flex-col p-6 overflow-hidden">
        <div class="text-center mb-6 animate-fade-in">
            <h1 class="text-2xl font-black text-white uppercase tracking-widest mb-1">Eleito!</h1>
            <p class="text-slate-400 text-sm">Parabéns, você assumiu a presidência <span id="setup-country-pre">da/do</span> <span id="setup-country-name" class="text-gold-500 font-bold text-lg">País</span>.</p>
            <p class="text-white font-bold mt-4">Como deseja governar seu país?</p>
        </div>
        <div id="setup-options" class="flex-1 overflow-y-auto space-y-3 pb-6 animate-slide-up scroll-hide">
            <!-- Options injected here -->
        </div>
    </div>

    <!-- Fullscreen Debate Modal -->
    <div id="debate-overlay" class="fixed inset-0 bg-presidential-blue z-[100] hidden flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-4xl font-black text-white mb-2 uppercase tracking-widest">Debate Continental</h1>
        <div class="w-full h-1 bg-white/20 mb-8 rounded-full overflow-hidden">
             <div id="debate-timer-bar" class="h-full bg-red-500 w-full transition-all duration-1000 ease-linear"></div>
        </div>
        
        <div id="debate-speaker-area" class="bg-white/10 p-6 rounded-2xl border border-white/20 w-full max-w-md backdrop-blur-lg mb-6">
            <p class="text-slate-300 text-xs uppercase mb-2">Com a palavra</p>
            <h2 class="text-3xl font-bold text-gold-400 mb-4" id="debate-speaker-name">BRASIL</h2>
            <div class="text-6xl font-mono text-white mb-4" id="debate-countdown">30</div>
            <p id="debate-topic" class="text-sm text-white italic">"Justifique a queda na economia..."</p>
        </div>

        <button onclick="Game.endSpeech()" id="btn-end-speech" class="w-full max-w-xs bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all hidden">
            ENCERRAR FALA
        </button>
        <p id="debate-wait-msg" class="text-slate-400 animate-pulse mt-4">Aguardando...</p>
    </div>

    <!-- Generic Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-dark-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl p-6 relative animate-slide-up">
            <!-- Content -->
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-white text-dark-900 px-6 py-3 rounded-full font-bold shadow-lg transform -translate-y-20 transition-all duration-300 z-[60] flex items-center gap-2 pointer-events-none opacity-0">
        <i data-lucide="bell" class="w-5 h-5"></i>
        <span id="toast-message">Notificação</span>
    </div>

    <!-- Navbar -->
    <nav id="game-nav" class="h-20 glass-panel fixed bottom-0 w-full z-40 flex justify-around items-center pb-4 shrink-0 hidden">
        <button onclick="router.navigate('country')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <i data-lucide="landmark" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">País</span>
        </button>
        <button onclick="router.navigate('map')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <i data-lucide="map" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Mapa</span>
        </button>
        <button onclick="router.navigate('decisions')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <div class="relative">
                <i data-lucide="gavel" class="w-6 h-6"></i>
                <span id="badge-decision" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse hidden"></span>
            </div>
            <span class="text-[10px] font-bold">Decisões</span>
        </button>
        <button onclick="router.navigate('relations')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Relações</span>
        </button>
        <button onclick="router.navigate('news')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <div class="relative">
                <i data-lucide="newspaper" class="w-6 h-6"></i>
                <span id="badge-news" class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full hidden"></span>
            </div>
            <span class="text-[10px] font-bold">Notícias</span>
        </button>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        const COUNTRIES = [
            { id: 've', name: 'Venezuela', path: 'M 90 20 L 150 30 L 140 70 L 90 80 Z' },
            { id: 'co', name: 'Colômbia', path: 'M 40 40 L 90 20 L 90 80 L 40 90 Z' },
            { id: 'pe', name: 'Peru', path: 'M 30 90 L 90 80 L 100 160 L 40 180 Z' },
            { id: 'br', name: 'Brasil', path: 'M 90 80 L 140 70 L 190 90 L 210 180 L 150 240 L 100 160 Z' },
            { id: 'cl', name: 'Chile', path: 'M 50 200 L 70 200 L 70 420 L 50 400 Z' },
            { id: 'ar', name: 'Argentina', path: 'M 80 200 L 150 240 L 120 400 L 70 420 L 70 200 Z' }
        ];

        const ALL_GOV_STYLES = [
            { id: 'populist', name: 'Populismo Carismático', desc: 'Discurso forte e promessas. Pop sobe fácil, Eco instável.', bonus: { pop: 20, eco: -10 } },
            { id: 'liberal', name: 'Liberal Econômico', desc: 'Mercado acima de tudo. Eco cresce rápido, Pop sensível a crises.', bonus: { eco: 20, pop: -10 } },
            { id: 'state', name: 'Estado Forte', desc: 'Centralizador. Estabilidade alta, espionagem eficiente.', bonus: { stab: 20 } },
            { id: 'technocrat', name: 'Tecnocracia', desc: 'Decisões técnicas. Erros punem mais, acertos dão bônus extra.', bonus: { eco: 10, stab: 10 } },
            { id: 'nationalist', name: 'Nacionalismo Econômico', desc: 'Proteção interna. Resiste a crises externas, cresce devagar.', bonus: { stab: 15, eco: -5 } },
            { id: 'diplomat', name: 'Diplomacia Estratégica', desc: 'Foco externo. Alianças rendem mais, traições custam caro.', bonus: { pop: 5 } },
            { id: 'welfare', name: 'Governo Assistencialista', desc: 'Bem-estar social. Pop alta, Eco lenta, resiste a crises sociais.', bonus: { pop: 25, eco: -15 } },
            { id: 'corporate', name: 'Governo Empresarial', desc: 'País como empresa. Investimentos altos, Fake News doem mais.', bonus: { eco: 25, pop: -20 } },
            { id: 'shadow', name: 'Autoritarismo Velado', desc: 'Controle discreto. Ocultar dados custa pouco.', bonus: { stab: 10 } },
            { id: 'federal', name: 'Federalismo Forte', desc: 'Poder distribuído. Crises menores, decisões com menos impacto extremo.', bonus: { stab: 25 } },
            { id: 'reformist', name: 'Reformismo Contínuo', desc: 'Mudança constante. Eventos frequentes, decisões menos punitivas.', bonus: { eco: 5, pop: 5 } },
            { id: 'isolationist', name: 'Isolacionismo', desc: 'Fechado. Imune a fake news externas, economia lenta.', bonus: { stab: 30, eco: -15 } },
            { id: 'media', name: 'Governo Midiático', desc: 'Controle narrativo. Notícias positivas valem dobro.', bonus: { pop: 10 } },
            { id: 'militarized', name: 'Governo Militarizado', desc: 'Ordem total. Estabilidade máxima, Pop cai em debates.', bonus: { stab: 35, pop: -15 } },
            { id: 'participatory', name: 'Democracia Participativa', desc: 'Guiado pelo povo. Ocultar dados é fatal, decisões populares dão bônus.', bonus: { pop: 15 } },
            { id: 'oligarchy', name: 'Oligarquia Econômica', desc: 'Elite no poder. Eco cresce sem Pop, crises políticas perigosas.', bonus: { eco: 30, pop: -30 } },
            { id: 'green', name: 'Governo Verde', desc: 'Sustentável. Imune a crises ambientais, crescimento lento.', bonus: { pop: 10, eco: -5 } },
            { id: 'pragmatist', name: 'Governo Pragmatista', desc: 'Sem ideologia. Adaptável, sem grandes bônus ou ônus.', bonus: { stab: 5, eco: 5, pop: 5 } },
            { id: 'religious', name: 'Governo Religioso', desc: 'Moral e tradição. Pop estável, escândalos morais devastadores.', bonus: { stab: 10, pop: 10 } },
            { id: 'crisis', name: 'Governo de Crise', desc: 'Assume no caos. Começa mal, viradas dão bônus enormes.', bonus: { eco: -20, pop: -20, stab: -20 } }
        ];

        const DECISIONS_POOL = [
            { 
                text: "Privatizar estatal de energia elétrica?", 
                yes: { desc: "Venda rápida gera caixa, mas tarifas podem subir.", effect: { eco: 15, pop: -10 } },
                no: { desc: "Mantém controle estatal e preços, mas aumenta dívida.", effect: { stab: 5, eco: -5 } }
            },
            { 
                text: "Aumentar salário mínimo acima da inflação?", 
                yes: { desc: "Aumenta poder de compra e felicidade, mas pressiona contas.", effect: { pop: 15, eco: -15 } },
                no: { desc: "Austeridade fiscal agrada mercado, mas povo reclama.", effect: { eco: 10, pop: -10 } }
            },
            { 
                text: "Censurar jornal opositor por 'Fake News'?", 
                yes: { desc: "Silencia críticas e aumenta controle, mas gera revolta.", effect: { stab: 15, pop: -20 } },
                no: { desc: "Mantém liberdade de imprensa, mas críticas continuam.", effect: { pop: 5, stab: -5 } }
            },
            { 
                text: "Aceitar empréstimo do FMI com juros altos?", 
                yes: { desc: "Dinheiro entra agora, mas soberania é afetada.", effect: { eco: 20, stab: -15 } },
                no: { desc: "Recusa ajuda externa. Crise continua, mas com orgulho.", effect: { stab: 10, eco: -10 } }
            },
            { 
                text: "Investir pesado em propaganda do governo?", 
                yes: { desc: "Melhora imagem artificialmente, custa caro.", effect: { pop: 10, eco: -5 } },
                no: { desc: "Economiza recursos, mas perde narrativa.", effect: { eco: 5 } }
            },
            {
                text: "Decretar Estado de Sítio preventivo?",
                yes: { desc: "Controle total das ruas, medo generalizado.", effect: { stab: 30, pop: -25, eco: -10 } },
                no: { desc: "Mantém normalidade democrática.", effect: { pop: 5 } }
            },
            {
                text: "Romper relações com superpotência rival?",
                yes: { desc: "Agrado ideológico, mas perde parceiro comercial.", effect: { stab: 10, eco: -20 } },
                no: { desc: "Pragmatismo diplomático.", effect: { eco: 5 } }
            },
            {
                text: "Subsidiar combustível para caminhoneiros?",
                yes: { desc: "Evita greve imediata, rombo no orçamento.", effect: { stab: 10, eco: -15 } },
                no: { desc: "Risco de paralisação no país.", effect: { eco: 10, stab: -15 } }
            },
            {
                text: "Adotar criptomoeda como moeda oficial?",
                yes: { desc: "Modernidade atrai investidores de risco, mas gera instabilidade.", effect: { eco: 15, stab: -15 } },
                no: { desc: "Mantém moeda tradicional e controle do banco central.", effect: { stab: 5 } }
            },
            {
                text: "Criar imposto sobre grandes fortunas?",
                yes: { desc: "Aumenta arrecadação e agrada o povo, elite se revolta.", effect: { pop: 20, eco: -10 } },
                no: { desc: "Mantém investimentos da elite no país.", effect: { eco: 5, pop: -5 } }
            }
        ];

        // --- GAME ENGINE WITH PEERJS ---
        const Game = {
            state: {
                roomCode: null,
                myId: null,
                isHost: false,
                round: 1,
                phase: 'lobby', 
                players: [], 
                newsFeed: [],
                connectionStatus: 'disconnected'
            },
            peer: null,
            connections: [], 
            
            // Updated Prefix
            ID_PREFIX: 'ip-sa-v3-',

            initPeer: (idSuffix, isRetry = false) => {
                const peerId = Game.ID_PREFIX + idSuffix;
                
                if(Game.peer) {
                    Game.peer.destroy();
                }

                console.log(`Initializing Peer: ${peerId}`);
                Game.peer = new Peer(peerId, { debug: 1 });

                Game.peer.on('open', (id) => {
                    console.log('Peer Open. ID: ' + id);
                    Game.state.connectionStatus = 'connected';
                    
                    if(Game.state.isHost) {
                         // Only Host persists state for game continuity
                         Game.saveLocal();
                         router.navigate('lobby');
                         const el = document.getElementById('lobby-status');
                         if(el) el.innerText = 'Sala Online (Servidor Conectado)';
                         if(el) el.className = 'text-green-500 font-bold text-xs uppercase tracking-widest';
                    } else {
                        Game.connectToHost();
                    }
                });

                Game.peer.on('connection', (conn) => {
                    if (Game.state.isHost) {
                        Game.handleHostConnection(conn);
                    } else {
                        conn.on('data', (data) => Game.handleData(data));
                    }
                });

                Game.peer.on('error', (err) => {
                    console.error("Peer Error:", err);
                    
                    if(err.type === 'unavailable-id') {
                        if (Game.state.isHost && !isRetry) {
                            console.warn("Host ID taken. Generating new code...");
                            Game.createRoom(localStorage.getItem('p_name'), true);
                            return;
                        } else if (Game.state.isHost) {
                            showToast("Erro: ID Preso no Servidor. Tente novamente em 10s.", 'error');
                            Game.exitGame();
                            return;
                        }
                    }

                    let msg = "Erro de conexão.";
                    if(err.type === 'peer-unavailable') msg = "Sala não encontrada ou Host offline.";
                    if(err.type === 'network') msg = "Erro de Rede. Verifique sua internet.";
                    
                    showToast(msg, 'error');
                    
                    const el = document.getElementById('lobby-status');
                    if(el) {
                        el.innerText = 'Erro: ' + msg;
                        el.className = 'text-red-500 font-bold text-xs';
                    }
                });

                Game.peer.on('disconnected', () => {
                     console.log("Peer Disconnected from Server");
                     if(Game.peer && !Game.peer.destroyed) Game.peer.reconnect();
                });
            },

            // HOST LOGIC
            handleHostConnection: (conn) => {
                Game.connections.push(conn);
                conn.on('open', () => {
                    console.log("Host: New connection");
                    conn.send({ type: 'REQUEST_INFO' });
                });
                conn.on('data', (data) => Game.handleData(data, conn));
                conn.on('close', () => {
                    Game.connections = Game.connections.filter(c => c !== conn);
                });
            },

            broadcast: (data) => {
                if(!Game.state.isHost) return;
                Game.connections.forEach(conn => conn.send(data));
            },

            syncState: () => {
                Game.saveLocal();
                Game.broadcast({ type: 'SYNC_STATE', payload: Game.state });
                router.renderCurrent();
                router.renderHeader();
            },

            // CLIENT LOGIC
            connectToHost: () => {
                const hostId = Game.ID_PREFIX + Game.state.roomCode;
                console.log("Connecting to:", hostId);
                
                const conn = Game.peer.connect(hostId, {
                    reliable: true
                });
                
                conn.on('open', () => {
                    console.log("Client: Connected to Host");
                    showToast("Conectado à sala!");
                    Game.hostConn = conn;
                    // Client does NOT save local state anymore to force fresh start
                    // State comes from Host sync
                });

                conn.on('data', (data) => Game.handleData(data));
                
                conn.on('close', () => {
                    showToast("Desconectado do Host", 'error');
                    setTimeout(() => Game.exitGame(), 3000);
                });

                setTimeout(() => {
                    if(!Game.hostConn || !Game.hostConn.open) {
                        // showToast("Host demora a responder...", 'warning');
                    }
                }, 5000);
            },

            sendAction: (type, payload) => {
                const finalPayload = { ...payload };
                if (!finalPayload.senderId) {
                    finalPayload.senderId = Game.state.myId;
                }

                if (Game.state.isHost) {
                    Game.handleAction(type, finalPayload, Game.state.myId);
                } else if (Game.hostConn) {
                    Game.hostConn.send({ type: 'ACTION', actionType: type, payload: finalPayload });
                }
            },

            // COMMON DATA HANDLER
            handleData: (data, connSource = null) => {
                if (data.type === 'SYNC_STATE') {
                    const myId = Game.state.myId;
                    const isHost = Game.state.isHost;
                    const wasAtHome = router.current === 'home';

                    Game.state = data.payload;
                    Game.state.myId = myId;
                    Game.state.isHost = isHost;
                    // Note: Client does NOT saveLocal() here to avoid persistence on reload
                    if(isHost) Game.saveLocal(); 

                    if (wasAtHome) {
                        // Check if my ID is in the player list (synced from host)
                        const amIInList = Game.state.players.some(p => p.id === myId);
                        if (amIInList) {
                            if (Game.state.phase === 'lobby') {
                                router.navigate('lobby');
                            } else {
                                router.navigate('country');
                            }
                        }
                    }

                    router.renderCurrent();
                    router.renderHeader();
                    return;
                }
                
                if (data.type === 'GAME_IN_PROGRESS') {
                    router.navigate('spectator');
                    return;
                }

                if (Game.state.isHost) {
                    if (data.type === 'ACTION') {
                        Game.handleAction(data.actionType, data.payload, null);
                    }
                    if (data.type === 'JOIN_INFO') {
                        const incomingName = data.payload.name;
                        const incomingId = data.payload.id;
                        
                        // Check if player exists by NAME
                        const existingPlayerIndex = Game.state.players.findIndex(p => p.name === incomingName);
                        
                        if (existingPlayerIndex !== -1) {
                            // REJOIN LOGIC
                            console.log(`${incomingName} is rejoining.`);
                            // Update the ID to the new connection ID
                            Game.state.players[existingPlayerIndex].id = incomingId;
                            showToast(`${incomingName} reconectou!`);
                            Game.syncState();
                        } else {
                            // NEW PLAYER LOGIC
                            if (Game.state.phase === 'game') {
                                // Reject if game started and name not found
                                connSource.send({ type: 'GAME_IN_PROGRESS' });
                            } else {
                                const newPlayer = Game.createPlayerStruct(incomingId, incomingName);
                                Game.state.players.push(newPlayer);
                                showToast(`${newPlayer.name} entrou!`);
                                Game.syncState();
                            }
                        }
                    }
                } else {
                    if (data.type === 'REQUEST_INFO') {
                        const me = Game.createPlayerStruct(Game.state.myId, localStorage.getItem('p_name') || 'Jogador');
                        Game.hostConn.send({ type: 'JOIN_INFO', payload: me });
                    }
                }
            },

            // GAME LOGIC
            handleAction: (type, payload, localSenderId) => {
                if (!Game.state.isHost) return;

                const senderId = payload.senderId || localSenderId;
                const player = Game.state.players.find(p => p.id === senderId);

                if (!player && type !== 'JOIN_INFO') {
                     console.warn("Action received from unknown player:", senderId);
                     return;
                }

                switch (type) {
                    case 'START_MATCH':
                        Game.startMatchLogic();
                        break;
                    case 'CHOOSE_GOV':
                        if(player) {
                            const style = ALL_GOV_STYLES.find(s => s.id === payload.styleId);
                            player.style = style;
                            if (style.bonus.eco) player.stats.eco += style.bonus.eco;
                            if (style.bonus.pop) player.stats.pop += style.bonus.pop;
                            if (style.bonus.stab) player.stats.stab += style.bonus.stab;
                            ['eco','pop','stab'].forEach(k => player.stats[k] = Math.max(0, Math.min(100, player.stats[k])));
                        }
                        break;
                    case 'TOGGLE_VISIBILITY':
                        if(player && !player.visibilityChangedThisRound) {
                            player.visibility = player.visibility === 'public' ? 'anon' : 'public';
                            player.visibilityChangedThisRound = true;
                            if (player.visibility === 'anon' && player.style.id !== 'shadow') {
                                player.stats.pop -= 5;
                                Game.addNewsLogic(`Rumores sobre falta de transparência em ${player.country.name}.`, 'real');
                            }
                        }
                        break;
                    case 'RESOLVE_DILEMMA':
                        if(player && player.currentDilemma) {
                            const decision = player.currentDilemma;
                            const outcome = payload.choiceIndex === 0 ? decision.yes : decision.no;
                            
                            if (outcome.effect.eco) player.stats.eco += outcome.effect.eco;
                            if (outcome.effect.pop) player.stats.pop += outcome.effect.pop;
                            if (outcome.effect.stab) player.stats.stab += outcome.effect.stab;
                            ['eco','pop','stab'].forEach(k => player.stats[k] = Math.max(0, Math.min(100, player.stats[k])));
                            
                            const actionText = payload.choiceIndex === 0 ? "aprovou" : "rejeitou";
                            Game.addNewsLogic(`${player.country.name} ${actionText}: ${decision.text}`, 'real');
                            
                            // 3 DECISIONS LOGIC
                            player.currentDilemma = null;
                            if (player.dilemmaQueue && player.dilemmaQueue.length > 0) {
                                player.currentDilemma = player.dilemmaQueue.shift();
                            } else {
                                player.hasActed = true;
                                const allActed = Game.state.players.every(p => p.hasActed);
                                if(allActed) {
                                    setTimeout(() => Game.checkGamePhaseLogic(), 2000);
                                }
                            }
                        }
                        break;
                    case 'FAKE_NEWS':
                        if(player) {
                             Game.addNewsLogic(`Vazamento: ${payload.headline} em ${payload.targetName}!`, 'fake', player.id);
                        }
                        break;
                    case 'DEPLOY_SPY':
                        if(Math.random() > 0.5) {
                            // Success logic could return data to private user
                        } else {
                            const target = Game.state.players.find(p => p.id === payload.targetId);
                            Game.addNewsLogic(`Espião estrangeiro capturado em ${target.country.name}!`, 'real');
                            target.stats.stab -= 5;
                        }
                        break;
                    case 'END_SPEECH':
                         Game.debateNextSpeakerLogic();
                         break;
                }

                Game.syncState();
            },

            // --- LOBBY & SETUP ---
            
            createRoom: (name, forceNewCode = false) => {
                localStorage.setItem('p_name', name);
                
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
                let code = "";
                for(let i=0; i<5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
                
                const myId = 'p-' + Date.now();
                
                Game.state.roomCode = code;
                Game.state.myId = myId;
                Game.state.isHost = true;
                Game.state.players = [Game.createPlayerStruct(myId, name)];
                
                // Initialize Peer with new code
                Game.initPeer(code, forceNewCode);
            },

            joinRoom: (name, code) => {
                localStorage.setItem('p_name', name);
                code = code.toUpperCase().trim();
                
                const myId = 'p-' + Date.now() + Math.random().toString(36).substr(2, 5);
                Game.state.roomCode = code;
                Game.state.myId = myId;
                Game.state.isHost = false;
                
                const randomClientId = 'client-' + Math.random().toString(36).substr(2, 9);
                Game.initPeer(randomClientId);
            },

            createPlayerStruct: (id, name) => {
                return {
                    id, name, 
                    isHuman: true,
                    country: null,
                    style: null,
                    stats: { eco: 50, stab: 50, pop: 50 },
                    visibility: 'public',
                    hasActed: false,
                    visibilityChangedThisRound: false,
                    currentDilemma: null,
                    dilemmaQueue: []
                };
            },

            exitGame: () => {
                localStorage.removeItem('presidentes_game');
                if(Game.peer) Game.peer.destroy();
                location.reload();
            },

            saveLocal: () => {
                localStorage.setItem('presidentes_game', JSON.stringify(Game.state));
            },

            loadLocal: () => {
                const data = localStorage.getItem('presidentes_game');
                if(data) { 
                    try {
                        Game.state = JSON.parse(data);
                        return true;
                    } catch(e) {
                        return false;
                    }
                } 
                return false; 
            },

            // --- LOGIC HELPERS ---

            getRandomDilemmas: (count) => {
                const selected = [];
                for(let i=0; i<count; i++) {
                    selected.push(DECISIONS_POOL[Math.floor(Math.random() * DECISIONS_POOL.length)]);
                }
                return selected;
            },

            startMatchLogic: () => {
                const shuffledCountries = [...COUNTRIES].sort(() => 0.5 - Math.random());
                Game.state.players.forEach((p, i) => {
                    p.country = shuffledCountries[i % shuffledCountries.length];
                });
                
                // 3 Decisions per round logic
                Game.state.players.forEach(p => {
                     p.dilemmaQueue = Game.getRandomDilemmas(3);
                     p.currentDilemma = p.dilemmaQueue.shift();
                });

                Game.state.phase = 'game';
                Game.syncState();
            },

            addNewsLogic: (text, type, sourceId = null) => {
                Game.state.newsFeed.unshift({ 
                    id: Date.now() + Math.random(), text, type, sourceId, round: Game.state.round 
                });
            },

            checkGamePhaseLogic: () => {
                if (Game.state.round === 4 || Game.state.round === 8) {
                    Game.startDebateLogic();
                } else {
                    Game.nextRoundLogic();
                }
            },

            nextRoundLogic: () => {
                Game.state.round++;
                Game.state.players.forEach(p => {
                    p.hasActed = false;
                    p.visibilityChangedThisRound = false;
                    p.dilemmaQueue = Game.getRandomDilemmas(3);
                    p.currentDilemma = p.dilemmaQueue.shift();
                });
                showToast(`Início do Semestre ${Game.state.round}`);
                Game.syncState();
            },

            startDebateLogic: () => {
                Game.state.debateQueue = [...Game.state.players];
                Game.state.isDebating = true;
                Game.debateNextSpeakerLogic();
            },

            debateNextSpeakerLogic: () => {
                if (Game.state.debateQueue.length === 0) {
                    Game.state.isDebating = false;
                    Game.state.currentSpeakerId = null;
                    Game.nextRoundLogic();
                    return;
                }
                const nextSpeaker = Game.state.debateQueue.shift();
                Game.state.currentSpeakerId = nextSpeaker.id;
                Game.state.debateStartTime = Date.now(); 
                Game.syncState();
            },

            // --- UI ACTIONS ---

            getMyPlayer: () => Game.state.players.find(p => p.id === Game.state.myId),

            uiConfirmGovernment: (styleId) => {
                Game.sendAction('CHOOSE_GOV', { styleId });
                document.getElementById('setup-overlay').classList.add('hidden');
                showToast("Governo Confirmado. Aguarde.");
            },
            
            uiToggleVisibility: () => {
                Game.sendAction('TOGGLE_VISIBILITY', {});
            },

            uiResolveDilemma: (choiceIndex) => {
                const me = Game.getMyPlayer();
                Game.sendAction('RESOLVE_DILEMMA', { choiceIndex, senderId: me.id });
                const container = document.getElementById('decision-card-container');
                if(container) container.innerHTML = '<div class="text-center p-10 animate-pulse">Enviando...</div>';
            },

            uiCreateFakeNews: (targetId, targetName, headline) => {
                Game.sendAction('FAKE_NEWS', { targetId, targetName, headline });
                closeModal();
            },

            uiDeploySpy: (targetId, sector) => {
                Game.sendAction('DEPLOY_SPY', { targetId, sector });
                closeModal();
                showToast("Espião enviado.");
            },

            endSpeech: () => {
                 Game.sendAction('END_SPEECH', { senderId: Game.state.myId });
            }
        };

        // --- ROUTER & RENDERERS ---
        const router = {
            current: 'home',
            navigate: (view) => {
                router.current = view;
                router.renderHeader();
                router.renderCurrent();
            },
            renderCurrent: () => {
                const container = document.getElementById('app-container');
                container.innerHTML = '';
                
                if (router.current === 'spectator') {
                    renderSpectator(container);
                    return;
                }

                if (Game.state.phase === 'game' && router.current === 'lobby') {
                    router.navigate('country');
                    return;
                }

                if (['home','lobby'].includes(router.current)) {
                     if(router.current === 'home') renderHome(container);
                     if(router.current === 'lobby') renderLobby(container);
                     lucide.createIcons();
                     return;
                }

                const me = Game.getMyPlayer();
                if (!me) { router.navigate('home'); return; }

                if (Game.state.isDebating) {
                    renderDebateOverlay();
                } else {
                    document.getElementById('debate-overlay').classList.add('hidden');
                }

                if (me.country && !me.style && Game.state.phase === 'game') {
                    renderCountry(container);
                    showGovernmentSelection();
                    return; 
                } else if (me.style) {
                     document.getElementById('setup-overlay').classList.add('hidden');
                }

                switch(router.current) {
                    case 'country': renderCountry(container); break;
                    case 'map': renderMap(container); break;
                    case 'decisions': renderDecisions(container); break;
                    case 'relations': renderRelations(container); break;
                    case 'news': renderNews(container); break;
                }
                lucide.createIcons();
            },
            renderHeader: () => {
                 const me = Game.getMyPlayer();
                 const header = document.getElementById('game-header');
                 const nav = document.getElementById('game-nav');
                 
                 if (Game.state.phase === 'game' && me && me.country) {
                    document.getElementById('header-country').innerText = me.country.name;
                    document.getElementById('round-display').innerText = `${Game.state.round}/8`;
                    header.classList.remove('hidden');
                    nav.classList.remove('hidden');
                 } else {
                    header.classList.add('hidden');
                    nav.classList.add('hidden');
                 }
                 
                 document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(router.current)) {
                        btn.classList.remove('opacity-60'); btn.classList.add('text-gold-500');
                    } else {
                        btn.classList.add('opacity-60'); btn.classList.remove('text-gold-500');
                    }
                });
            }
        };

        // --- VIEWS ---

        function renderDebateOverlay() {
            const overlay = document.getElementById('debate-overlay');
            overlay.classList.remove('hidden');
            
            const speakerId = Game.state.currentSpeakerId;
            const speaker = Game.state.players.find(p => p.id === speakerId);
            const isMe = speakerId === Game.state.myId;

            document.getElementById('debate-speaker-name').innerText = speaker ? speaker.country.name : "Carregando...";
            document.getElementById('debate-speaker-name').className = `text-3xl font-bold mb-4 ${isMe ? 'text-gold-400' : 'text-slate-400'}`;

            const btnEnd = document.getElementById('btn-end-speech');
            const waitMsg = document.getElementById('debate-wait-msg');
            const countdown = document.getElementById('debate-countdown');
            const timerBar = document.getElementById('debate-timer-bar');

            // Timer Logic (Synced)
            const duration = 30; // seconds
            const elapsed = Math.floor((Date.now() - (Game.state.debateStartTime || Date.now())) / 1000);
            const remaining = Math.max(0, duration - elapsed);
            
            countdown.innerText = remaining;
            timerBar.style.width = `${(remaining/duration)*100}%`;

            if (isMe) {
                btnEnd.classList.remove('hidden');
                waitMsg.classList.add('hidden');
                document.getElementById('debate-topic').innerText = "Sua vez! Discurse para os outros jogadores.";
                if(remaining === 0 && !window.debateEndSent) {
                     window.debateEndSent = true; 
                     Game.endSpeech();
                }
                if(remaining > 0) window.debateEndSent = false;
            } else {
                btnEnd.classList.add('hidden');
                waitMsg.classList.remove('hidden');
                document.getElementById('debate-topic').innerText = `${speaker ? speaker.name : 'Alguém'} está discursando...`;
            }

            if(!window.debateTimerLoop) {
                window.debateTimerLoop = setInterval(() => {
                    if(!Game.state.isDebating) {
                        clearInterval(window.debateTimerLoop);
                        window.debateTimerLoop = null;
                        return;
                    }
                    renderDebateOverlay(); 
                }, 1000);
            }
        }

        function renderHome(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center p-6 bg-dark-900 animate-fade-in">
                    <div class="mb-10 text-center">
                        <i data-lucide="globe-2" class="w-20 h-20 text-gold-500 mx-auto mb-4"></i>
                        <h1 class="text-3xl font-black text-white tracking-widest uppercase">Presidentes<br><span class="text-gold-500">América do Sul</span></h1>
                        <p class="text-slate-400 mt-2 text-sm">Online Multiplayer v3</p>
                    </div>
                    
                    <div class="w-full max-w-xs space-y-6">
                        <input type="text" id="player-name" placeholder="Seu Nome" class="w-full bg-slate-800 border border-slate-600 text-white p-4 rounded-xl focus:border-gold-500 outline-none transition-colors" value="${localStorage.getItem('p_name') || ''}">
                        
                        <div class="space-y-3">
                            <button onclick="handleCreateRoom()" class="w-full bg-gold-500 hover:bg-gold-400 text-dark-900 font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Criar Sala
                            </button>
                            <div class="flex gap-2">
                                <input type="text" id="room-code-input" placeholder="CODE" class="w-24 bg-slate-800 border border-slate-600 text-white p-4 rounded-xl text-center font-mono text-lg tracking-widest uppercase">
                                <button onclick="handleJoinRoom()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">
                                    Entrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSpectator(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center p-6 bg-dark-900 animate-fade-in text-center">
                    <i data-lucide="eye" class="w-16 h-16 text-slate-500 mb-4 animate-pulse"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">Partida em Andamento</h2>
                    <p class="text-slate-400 mb-6">Aguarde o fim da partida para entrar na próxima rodada.</p>
                    <button onclick="Game.exitGame()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">Voltar</button>
                </div>
            `;
        }

        function handleCreateRoom() {
            const name = document.getElementById('player-name').value;
            if(!name) return showToast('Digite um nome!');
            Game.createRoom(name);
        }

        function handleJoinRoom() {
            const name = document.getElementById('player-name').value;
            const code = document.getElementById('room-code-input').value;
            if(!name) return showToast('Digite um nome!');
            if(!code) return showToast('Digite o código!');
            Game.joinRoom(name, code);
        }

        function renderLobby(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col p-6 bg-dark-900 animate-slide-up">
                    <div class="text-center mb-8 mt-10">
                        <p id="lobby-status" class="text-slate-400 text-xs animate-pulse mb-2">Conectando ao servidor...</p>
                        <p class="text-slate-400 text-sm uppercase">Código da Sala</p>
                        <h1 class="text-6xl font-mono text-white tracking-widest my-2 select-all">${Game.state.roomCode}</h1>
                        <p class="text-slate-500 text-xs">Compartilhe este código para jogar com amigos</p>
                    </div>

                    <div class="flex-1 bg-slate-800/50 rounded-2xl p-4 border border-slate-700 mb-6">
                        <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 text-gold-500"></i> Jogadores (${Game.state.players.length})
                        </h3>
                        <div class="space-y-2">
                            ${Game.state.players.map(p => `
                                <div class="bg-slate-700 p-3 rounded-xl flex items-center gap-3">
                                    <div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                                    </div>
                                    <span class="text-white font-bold">${p.name}</span>
                                    ${p.id === Game.state.myId ? '<span class="text-xs bg-gold-500 text-dark-900 px-2 rounded font-bold">VOCÊ</span>' : ''}
                                    ${Game.state.isHost && p.id === Game.state.players[0].id ? '<span class="text-xs bg-blue-500 text-white px-2 rounded font-bold">HOST</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${Game.state.isHost ? `
                        <div class="text-center">
                        <button onclick="Game.sendAction('START_MATCH', {})" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-5 h-5"></i> Iniciar Jogo
                        </button>
                        <p class="text-xs text-slate-500 mt-2">Mínimo 2 jogadores recomendado</p>
                        </div>
                    ` : `
                        <p class="text-center text-slate-400 animate-pulse">Aguardando o anfitrião iniciar...</p>
                    `}
                </div>
            `;
        }
        
        function showGovernmentSelection() {
            const me = Game.getMyPlayer();
            const overlay = document.getElementById('setup-overlay');
            const optionsContainer = document.getElementById('setup-options');
            
            if (!overlay.classList.contains('hidden')) return;

            const options = [...ALL_GOV_STYLES].sort(() => 0.5 - Math.random()).slice(0, 4);
            const prep = ['Argentina', 'Colômbia', 'Venezuela'].includes(me.country.name) ? 'da' : 'do';

            document.getElementById('setup-country-pre').innerText = prep;
            document.getElementById('setup-country-name').innerText = me.country.name;

            optionsContainer.innerHTML = options.map(opt => `
                <button onclick="Game.uiConfirmGovernment('${opt.id}')" class="gov-card w-full bg-slate-800 border border-slate-600 hover:border-gold-500 rounded-xl p-4 text-left group relative overflow-hidden">
                    <h3 class="text-gold-500 font-black uppercase text-sm mb-1">${opt.name}</h3>
                    <p class="text-slate-300 text-xs leading-relaxed">${opt.desc}</p>
                    <div class="flex gap-2 mt-3">
                        ${Object.entries(opt.bonus).map(([k, v]) => `
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded ${v > 0 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
                                ${k.toUpperCase()} ${v > 0 ? '+' : ''}${v}
                            </span>
                        `).join('')}
                    </div>
                </button>
            `).join('');

            overlay.classList.remove('hidden');
        }

        function renderDecisions(container) {
            const me = Game.getMyPlayer();

            if (me.hasActed) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center p-6 text-center animate-fade-in">
                        <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 relative">
                            <i data-lucide="hourglass" class="w-10 h-10 text-gold-500 animate-pulse-slow"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Aguardando...</h2>
                        <p class="text-slate-400 max-w-xs mx-auto">Decisões finalizadas. Espere o fim do semestre.</p>
                    </div>
                `;
                return;
            }

            if (me.currentDilemma) {
                const d = me.currentDilemma;
                const remaining = (me.dilemmaQueue ? me.dilemmaQueue.length : 0) + 1;
                
                container.innerHTML = `
                    <div class="p-6 space-y-6 animate-fade-in pb-24">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-white">Gabinete</h2>
                            <span class="bg-slate-700 text-white text-xs px-2 py-1 rounded-full">Restam: ${remaining}</span>
                        </div>
                        <div id="decision-card-container" class="bg-gradient-to-br from-slate-800 to-slate-900 border border-gold-500/50 rounded-2xl p-1 shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gold-500 z-10"></div>
                            <div class="p-5">
                                <h3 class="text-gold-500 font-bold text-xs uppercase mb-2 tracking-wider">Decisão Obrigatória</h3>
                                <p class="text-lg text-white font-bold leading-relaxed mb-6">${d.text}</p>
                                <div class="space-y-3">
                                    <button onclick="Game.uiResolveDilemma(0)" class="w-full bg-green-900/30 border border-green-700/50 hover:bg-green-900/50 hover:border-green-500 rounded-xl p-3 text-left group transition-all active:scale-95">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-green-400 font-bold uppercase text-sm">Aprovar</span>
                                        </div>
                                        <p class="text-slate-300 text-xs mb-2">${d.yes.desc}</p>
                                    </button>
                                    <button onclick="Game.uiResolveDilemma(1)" class="w-full bg-red-900/30 border border-red-700/50 hover:bg-red-900/50 hover:border-red-500 rounded-xl p-3 text-left group transition-all active:scale-95">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-red-400 font-bold uppercase text-sm">Vetar</span>
                                        </div>
                                        <p class="text-slate-300 text-xs mb-2">${d.no.desc}</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderCountry(container) {
            const me = Game.getMyPlayer();
            if (!me) return;

            container.innerHTML = `
                <div class="p-6 space-y-6 animate-slide-up">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-white">${me.country.name}</h2>
                                <p class="text-gold-500 text-sm font-bold uppercase">${me.style ? me.style.name : 'Definindo Governo...'}</p>
                            </div>
                            <div class="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center">
                                <i data-lucide="flag" class="w-6 h-6 text-white"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="text-center"><div class="text-xs text-slate-400 uppercase font-bold mb-1">Economia</div><div class="text-xl font-bold text-green-400">${me.stats.eco}%</div></div>
                            <div class="text-center border-x border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold mb-1">Estab.</div><div class="text-xl font-bold text-blue-400">${me.stats.stab}%</div></div>
                            <div class="text-center"><div class="text-xs text-slate-400 uppercase font-bold mb-1">Popularidade</div><div class="text-xl font-bold text-gold-500">${me.stats.pop}%</div></div>
                        </div>
                        <button onclick="Game.uiToggleVisibility()" class="w-full flex items-center justify-between bg-slate-700/50 p-3 rounded-xl border border-slate-600 active:bg-slate-700 transition-colors ${me.visibilityChangedThisRound ? 'opacity-50 cursor-not-allowed' : ''}">
                            <div class="flex items-center gap-3">
                                <i data-lucide="${me.visibility === 'public' ? 'eye' : 'eye-off'}" class="w-5 h-5 ${me.visibility === 'public' ? 'text-green-400' : 'text-red-400'}"></i>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-white">Dados ${me.visibility === 'public' ? 'Públicos' : 'Anônimos'}</div>
                                </div>
                            </div>
                            <div class="w-2 h-2 rounded-full ${me.visibility === 'public' ? 'bg-green-500' : 'bg-red-500'}"></div>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderMap(container) {
             container.innerHTML = `
                <div class="h-full flex flex-col bg-[#1e293b] animate-fade-in relative">
                    <h2 class="absolute top-4 left-6 text-2xl font-black text-white/10 z-0">AMÉRICA<br>DO SUL</h2>
                    <div class="flex-1 flex items-center justify-center p-4 z-10">
                        <svg viewBox="0 0 240 450" class="w-full h-full drop-shadow-2xl">
                            ${COUNTRIES.map(c => {
                                const owner = Game.state.players.find(p => p.country && p.country.id === c.id);
                                const fillColor = owner ? '#EAB308' : '#334155';
                                const strokeColor = owner ? '#FEF08A' : '#475569';
                                return `<path id="map-${c.id}" d="${c.path}" class="country-path" style="fill: ${fillColor}; stroke: ${strokeColor};" onclick="openCountryDetails('${c.id}')" />`;
                            }).join('')}
                        </svg>
                    </div>
                </div>
            `;
        }
        function renderRelations(container) {
             container.innerHTML = `
             <div class="p-6 space-y-4 animate-fade-in pb-24">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Relações Exteriores</h2>
                    <div class="bg-slate-800 border border-slate-600 px-3 py-1 rounded-lg text-xs font-mono text-gold-500 tracking-widest">
                        CODE: ${Game.state.roomCode}
                    </div>
                </div>
                <div class="space-y-2">
                    ${Game.state.players.map(p => `
                        <div class="bg-dark-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center font-bold text-white text-xs border border-slate-500">
                                    ${p.country ? p.country.id.toUpperCase() : '??'}
                                </div>
                                <div>
                                    <div class="font-bold text-white">${p.name}</div>
                                    <div class="text-xs text-slate-400">${p.country ? p.country.name : '...'}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
             </div>`;
        }
        function renderNews(container) {
             const me = Game.getMyPlayer();
            const feed = Game.state.newsFeed.map(n => {
                let displayType = 'real';
                if (n.type === 'fake') displayType = (n.sourceId === me.id) ? 'fake' : 'real'; 
                return { ...n, displayType };
            });
            document.getElementById('badge-news').classList.add('hidden');
            container.innerHTML = `<div class="p-6 animate-fade-in pb-24"><h2 class="text-2xl font-bold text-white mb-6">Central de Notícias</h2><div class="space-y-4">${feed.map(n => `<div class="bg-dark-800 p-4 rounded-r-xl news-item news-${n.displayType}"><div class="flex justify-between items-start mb-1"><span class="text-[10px] font-bold uppercase text-slate-400">Semestre ${n.round}</span>${n.displayType === 'fake' ? '<span class="text-[10px] bg-purple-900 text-purple-300 px-2 rounded">SEU FAKE</span>' : ''}</div><p class="text-sm text-slate-200 leading-snug">${n.text}</p></div>`).join('')}${feed.length === 0 ? '<p class="text-center text-slate-500 mt-10">Nenhuma notícia recente.</p>' : ''}</div></div>`;
        }

        function openCountryDetails(id) { 
             const target = Game.state.players.find(p => p.country && p.country.id === id);
             const modal = document.getElementById('modal-overlay');
             const content = document.getElementById('modal-content');
             modal.classList.remove('hidden');
             if (!target) { content.innerHTML = `<h3 class="text-white font-bold">País Neutro</h3><button onclick="closeModal()" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Fechar</button>`; return; }
             const isPublic = target.visibility === 'public';
             content.innerHTML = `<div class="text-center mb-6"><h2 class="text-2xl font-bold text-white mb-1">${target.country.name}</h2><p class="text-gold-500 text-xs font-bold uppercase">${target.name}</p></div><div class="bg-slate-900/50 p-4 rounded-xl mb-4 border border-slate-700"><div class="flex justify-between items-center mb-2"><span class="text-slate-400 text-sm">Popularidade</span><span class="text-white font-bold">${isPublic ? target.stats.pop + '%' : '???'}</span></div></div><div class="grid grid-cols-2 gap-2"><button onclick="Game.uiDeploySpy('${target.id}','gov')" class="bg-red-900/50 py-3 text-red-100 rounded text-xs font-bold">Espionar</button><button onclick="openFakeNewsMenu('${target.id}', '${target.country.name}')" class="bg-purple-900/50 py-3 text-purple-100 rounded text-xs font-bold">Fake News</button></div><button onclick="closeModal()" class="mt-4 w-full text-slate-400 text-sm">Fechar</button>`;
        }

        function openFakeNewsMenu(targetId, targetName) {
             const content = document.getElementById('modal-content');
             content.innerHTML = `
                <h3 class="text-lg font-bold text-purple-400 mb-4">Criar Fake News</h3>
                <input type="text" id="fake-news-input" placeholder="Ex: Presidente aceitou propina..." class="w-full bg-slate-900 border border-slate-600 text-white p-3 rounded-lg mb-4 text-sm">
                <button onclick="Game.uiCreateFakeNews('${targetId}', '${targetName}', document.getElementById('fake-news-input').value)" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl">Espalhar Rumor</button>
                <button onclick="closeModal()" class="mt-2 w-full text-slate-400">Cancelar</button>
            `;
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function showToast(msg, type='info') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('-translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('-translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
             // Disabled auto-load to force clean state on refresh
             router.navigate('home');
        });

    </script>
</body>
</html>