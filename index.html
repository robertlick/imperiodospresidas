<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Império dos Presidentes</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: { 400: '#FACC15', 500: '#EAB308', 600: '#CA8A04' },
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        nav: { 900: '#111827' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'zoom-in': 'zoomIn 0.5s cubic-bezier(0, 0, 0.2, 1)',
                        'pulse-slow': 'pulse 3s infinite',
                        'intro-text': 'introText 2s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        zoomIn: { '0%': { transform: 'scale(0.5)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        introText: { '0%': { transform: 'scale(0.8) translateY(20px)', opacity: '0' }, '100%': { transform: 'scale(1) translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        html { height: 100dvh; overflow: hidden; background-color: #0f172a; }
        body { height: 100%; width: 100%; overflow: hidden; display: flex; flex-direction: column; }
        
        #app-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            width: 100%;
            padding-bottom: 0;
        }

        .has-nav { padding-bottom: 110px; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        
        .country-path { transition: all 0.2s ease; cursor: pointer; stroke-linejoin: round; stroke-width: 1; }
        .country-path:hover { filter: brightness(1.2); stroke: white; stroke-width: 2; z-index: 10; position: relative; }
        
        .glass-panel { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.05); }
        
        /* Tooltip for badges */
        .badge-icon:hover + .badge-tooltip { opacity: 1; pointer-events: auto; }
        
        .crisis-glow { animation: crisisPulse 2s infinite; }
        @keyframes crisisPulse { 0% { stroke: #ef4444; stroke-width: 2; } 50% { stroke: #7f1d1d; stroke-width: 4; } 100% { stroke: #ef4444; stroke-width: 2; } }
    </style>
</head>
<body class="text-slate-100 font-sans antialiased selection:bg-gold-500 selection:text-black">

    <!-- Top Bar -->
    <header id="game-header" class="shrink-0 flex flex-col bg-dark-900 border-b border-slate-700 z-30 hidden transition-all">
        <!-- Top Row -->
        <div class="h-14 flex items-center justify-between px-4">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center border border-slate-500 overflow-hidden shrink-0">
                    <i data-lucide="flag" class="w-4 h-4 text-white"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-400 font-bold uppercase leading-none">Presidente</span>
                    <span class="font-bold text-sm text-white leading-tight truncate w-24" id="header-country">País</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Calendário</span>
                    <span class="text-sm font-bold text-gold-500 leading-none" id="round-display">Ano 1/4 • Semestre 1/2</span>
                </div>
                <button onclick="Game.exitGame()" class="p-2 bg-red-900/20 text-red-400 rounded hover:bg-red-900/40">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <!-- Stats Row -->
        <div class="h-8 bg-slate-800 flex items-center justify-around px-2 text-xs font-bold border-t border-slate-700/50">
             <div class="flex items-center gap-1 text-green-400">
                 <i data-lucide="dollar-sign" class="w-3 h-3"></i> <span id="stat-eco">50%</span>
             </div>
             <div class="flex items-center gap-1 text-blue-400">
                 <i data-lucide="users" class="w-3 h-3"></i> <span id="stat-pop">50%</span>
             </div>
             <div class="flex items-center gap-1 text-purple-400">
                 <i data-lucide="shield" class="w-3 h-3"></i> <span id="stat-stab">50%</span>
             </div>
             <div class="flex items-center gap-1 text-gold-500">
                 <i data-lucide="crown" class="w-3 h-3"></i> <span id="stat-inf">0</span>
             </div>
        </div>
    </header>

    <!-- Main Scrollable Area -->
    <main id="app-container" class="scroll-hide scroll-smooth">
        <!-- Views injected here -->
    </main>

    <!-- Navbar -->
    <nav id="game-nav" class="h-20 shrink-0 glass-panel fixed bottom-0 w-full z-40 flex justify-around items-center pb-2 hidden">
        <button onclick="router.navigate('country')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all text-slate-300">
            <i data-lucide="landmark" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">País</span>
        </button>
        <button onclick="router.navigate('map')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all text-slate-300">
            <i data-lucide="map" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Mapa</span>
        </button>
        <button onclick="router.navigate('decisions')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all text-slate-300">
            <div class="relative">
                <i data-lucide="gavel" class="w-6 h-6"></i>
                <span id="badge-decision" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse hidden"></span>
            </div>
            <span class="text-[10px] font-bold">Decisões</span>
        </button>
        <button onclick="router.navigate('relations')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all text-slate-300">
             <div class="relative">
                <i data-lucide="users" class="w-6 h-6"></i>
                <span id="badge-relations" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden animate-pulse"></span>
            </div>
            <span class="text-[10px] font-bold">Relações</span>
        </button>
        <button onclick="router.navigate('news')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all text-slate-300">
            <div class="relative">
                <i data-lucide="newspaper" class="w-6 h-6"></i>
                <span id="badge-news" class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full hidden"></span>
            </div>
            <span class="text-[10px] font-bold">Notícias</span>
        </button>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-dark-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl p-6 relative animate-slide-up max-h-[85vh] overflow-y-auto"></div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="fixed top-28 left-1/2 -translate-x-1/2 bg-white text-dark-900 px-6 py-3 rounded-full font-bold shadow-lg transform -translate-y-40 transition-all duration-300 z-[100] flex items-center gap-2 pointer-events-none opacity-0">
        <span id="toast-message">Msg</span>
    </div>

    <script>
        // --- CONSTANTS ---
        const COUNTRIES = [
            { id: 've', name: 'Venezuela', path: 'M115,20 C125,20 140,25 150,30 L160,50 L140,65 L110,60 L105,40 Z', center: {x: 130, y: 40} },
            { id: 'co', name: 'Colômbia', path: 'M95,25 L115,20 L110,60 L100,75 L80,60 L80,35 Z', center: {x: 95, y: 50} },
            { id: 'ec', name: 'Equador', path: 'M75,60 L90,62 L85,75 L70,70 Z', center: {x: 80, y: 65}, neutral: true },
            { id: 'pe', name: 'Peru', path: 'M85,75 L100,75 L110,100 L115,115 L100,140 L70,120 L70,90 Z', center: {x: 90, y: 100} },
            { id: 'gy', name: 'Guianas', path: 'M150,30 L185,35 L195,50 L160,50 Z', center: {x: 170, y: 40}, neutral: true },
            { id: 'br', name: 'Brasil', path: 'M160,50 L195,50 L240,80 L250,110 L220,160 L180,180 L160,160 L140,150 L120,115 L110,100 L110,60 L140,65 Z', center: {x: 180, y: 110} },
            { id: 'bo', name: 'Bolívia', path: 'M115,115 L140,150 L140,175 L115,170 L100,140 Z', center: {x: 125, y: 145} },
            { id: 'py', name: 'Paraguai', path: 'M140,175 L160,160 L165,190 L145,195 Z', center: {x: 152, y: 180}, neutral: true },
            { id: 'cl', name: 'Chile', path: 'M95,160 L110,170 L105,330 L90,340 L85,200 Z', center: {x: 95, y: 240} },
            { id: 'ar', name: 'Argentina', path: 'M115,170 L145,195 L155,230 L135,340 L105,330 L110,200 Z', center: {x: 130, y: 260} },
            { id: 'uy', name: 'Uruguai', path: 'M155,230 L175,230 L170,250 L160,245 Z', center: {x: 165, y: 240}, neutral: true }
        ];

        const GOV_STYLES = [
            { id: 'lib', name: 'Liberal', desc: 'Foco total no mercado e privatizações.', immune: [], bonus: { eco: 1.25, pop: 0.9, stab: 1.0 }, initial: { eco: 15, stab: -10 } },
            { id: 'soc', name: 'Socialista', desc: 'Prioridade em programas sociais.', immune: [], bonus: { eco: 0.9, pop: 1.25, stab: 1.0 }, initial: { pop: 15, eco: -5 } },
            { id: 'mil', name: 'Militar', desc: 'Ordem através da força.', immune: ['spy'], bonus: { eco: 1.0, pop: 0.85, stab: 1.3 }, initial: { stab: 15, pop: -5 } },
            { id: 'tec', name: 'Tecnocrata', desc: 'Eficiência governada por especialistas.', immune: ['coup'], bonus: { eco: 1.15, pop: 1.0, stab: 1.15 }, initial: { eco: 10, stab: 5 } },
            { id: 'pop', name: 'Populista', desc: 'Discurso para as massas.', immune: [], bonus: { eco: 0.8, pop: 1.4, stab: 0.9 }, initial: { pop: 20, eco: -10 } },
            { id: 'oli', name: 'Oligarquia', desc: 'Governo para a elite econômica.', immune: [], bonus: { eco: 1.2, pop: 0.7, stab: 1.2 }, initial: { eco: 20, pop: -10 } },
            { id: 'teo', name: 'Teocracia', desc: 'União entre fé e estado.', immune: [], bonus: { eco: 0.9, pop: 1.0, stab: 1.4 }, initial: { stab: 20, eco: -10 } },
            { id: 'anc', name: 'Libertário', desc: 'Estado mínimo absoluto.', immune: [], bonus: { eco: 1.4, pop: 1.0, stab: 0.6 }, initial: { eco: 20, stab: -15 } }
        ];

        const BADGES = [
            { id: 'b_iron', name: 'Punho de Ferro', desc: 'Governou com autoritarismo extremo.', icon: 'gavel', color: 'text-red-500', bg: 'bg-red-900' },
            { id: 'b_gold', name: 'Rei Midas', desc: 'Acumulou riqueza ignorando o social.', icon: 'coins', color: 'text-yellow-400', bg: 'bg-yellow-900' },
            { id: 'b_dove', name: 'Pacificador', desc: 'Resolveu conflitos com diplomacia.', icon: 'heart', color: 'text-blue-400', bg: 'bg-blue-900' },
            { id: 'b_spy', name: 'Grande Irmão', desc: 'Manipulou a informação a seu favor.', icon: 'eye', color: 'text-purple-500', bg: 'bg-purple-900' },
            { id: 'b_builder', name: 'Arquiteto', desc: 'Focou em infraestrutura massiva.', icon: 'hammer', color: 'text-orange-500', bg: 'bg-orange-900' }
        ];

        // PROJECTS = Long Term Investments (Duration is in Semesters)
        const PROJECTS = [
            { id: 'p_hosp', name: 'SUS Continental', desc: 'Saúde gratuita.', cost: { eco: 25 }, duration: 4, yield: { pop: 5 }, badge: 'b_dove' },
            { id: 'p_road', name: 'Ferrovia Bioceânica', desc: 'Logística.', cost: { eco: 40 }, duration: 4, yield: { eco: 10 }, badge: 'b_builder' },
            { id: 'p_base', name: 'Muralha de Fronteira', desc: 'Segurança.', cost: { eco: 20 }, duration: 2, yield: { stab: 10 }, badge: 'b_iron' },
            { id: 'p_uni', name: 'Vale do Silício Latino', desc: 'Tecnologia.', cost: { eco: 30 }, duration: 6, yield: { eco: 5, pop: 5 } },
            { id: 'p_nuc', name: 'Programa Espacial', desc: 'Prestígio.', cost: { eco: 50 }, duration: 4, yield: { stab: 5, pop: 5 }, badge: 'b_builder' },
            { id: 'p_oil', name: 'Refinaria Nacional', desc: 'Soberania.', cost: { eco: 35 }, duration: 4, yield: { eco: 15 }, badge: 'b_gold' },
            { id: 'p_fest', name: 'Olimpíadas', desc: 'Turismo e imagem.', cost: { eco: 45 }, duration: 2, yield: { pop: 20 } }
        ];

        // INVESTMENTS = Instant Trade-offs
        const INVESTMENT_POOL = [
            { id: 'i_1', name: 'Subsídio Agrícola', desc: 'Apoio rural.', cost: { eco: 10 }, gain: { pop: 15 } },
            { id: 'i_2', name: 'Corte de Gastos', desc: 'Austeridade.', cost: { pop: 10 }, gain: { eco: 15 } },
            { id: 'i_3', name: 'Lei Marcial', desc: 'Ordem total.', cost: { pop: 15 }, gain: { stab: 20 } },
            { id: 'i_4', name: 'Propaganda Estatal', desc: 'Mídia a favor.', cost: { eco: 10 }, gain: { pop: 10, stab: 5 } },
            { id: 'i_5', name: 'Venda de Reservas', desc: 'Dinheiro rápido.', cost: { stab: 5 }, gain: { eco: 15 } },
            { id: 'i_6', name: 'Bolsa Família', desc: 'Auxílio direto.', cost: { eco: 15 }, gain: { pop: 20 } },
            { id: 'i_7', name: 'Aparelhar Estado', desc: 'Controle.', cost: { eco: 5 }, gain: { stab: 10 } },
            { id: 'i_8', name: 'Privatizar Água', desc: 'Eficiência.', cost: { pop: 10 }, gain: { eco: 20 } }
        ];

        const DECISION_POOL = [
            // Mandatory First
            { id: 'd_tax', text: "Reforma Tributária: Taxar grandes fortunas para salvar o orçamento?", 
              yes: { label: "Taxar", desc: "+Caixa, -Apoio Elite", eff: { eco: 15, stab: -5 }, badge: 'b_dove' }, 
              no: { label: "Isentar", desc: "Agradar Mercado", eff: { eco: 5, pop: -5 }, badge: 'b_gold' } },
            
            // General
            { id: 'd_flu', text: "Pandemia Viral: Um novo vírus se espalha. Fechar fronteiras?", 
              yes: { label: "Fechar Tudo", desc: "Colapso econômico", eff: { eco: -20, pop: 10 } }, 
              no: { label: "Manter Aberto", desc: "Risco de saúde", eff: { eco: 5, pop: -15 } } },
              
            { id: 'd_coup', text: "Rumores de Golpe: Generais exigem mais poder.", 
              yes: { label: "Ceder Poder", desc: "Governo fantoche", eff: { stab: 20, pop: -15 }, badge: 'b_iron' }, 
              no: { label: "Expurgar", desc: "Arriscado", eff: { stab: -15, pop: 10 } } },

            { id: 'd_oil', text: "Reserva de Petróleo: Descoberta em área indígena.", 
              yes: { label: "Explorar", desc: "Lucro imediato", eff: { eco: 20, pop: -10 }, badge: 'b_gold' }, 
              no: { label: "Proteger", desc: "Preservação", eff: { pop: 15, eco: -5 } } },
            
            { id: 'd_debt', text: "Dívida Externa: FMI exige cortes drásticos.", 
              yes: { label: "Aceitar", desc: "Austeridade", eff: { eco: 10, pop: -15 } }, 
              no: { label: "Calote", desc: "Isolamento", eff: { eco: -15, stab: 10 } } },

            { id: 'd_midia', text: "Controle de Mídia: Jornalistas criticam o governo.", 
              yes: { label: "Censurar", desc: "Lei da mordaça", eff: { stab: 15, pop: -10 }, badge: 'b_spy' }, 
              no: { label: "Liberdade", desc: "Imprensa livre", eff: { pop: 10, stab: -5 } } },
              
            { id: 'd_crime', text: "Onda de Crime: Cartéis dominam as favelas.", 
              yes: { label: "Invasão Militar", desc: "Guerra urbana", eff: { stab: 15, eco: -10 }, badge: 'b_iron' }, 
              no: { label: "Social", desc: "Programas de base", eff: { pop: 15, eco: -15 } } },

            { id: 'd_trade', text: "Acordo China: Vender estatais estratégicas?", 
              yes: { label: "Vender", desc: "Dinheiro rápido", eff: { eco: 20, stab: -5 }, badge: 'b_gold' }, 
              no: { label: "Nacionalizar", desc: "Soberania", eff: { stab: 10, eco: -10 } } },
              
            { id: 'd_edu', text: "Greve dos Professores: Exigem aumento salarial.", 
              yes: { label: "Aumentar", desc: "Custo alto", eff: { pop: 15, eco: -10 } }, 
              no: { label: "Ignorar", desc: "Greve continua", eff: { pop: -15, eco: 5 } } },

            { id: 'd_spy_sat', text: "Escândalo de Espionagem: Vazamento de dados.", 
              yes: { label: "Abafar", desc: "Esconder tudo", eff: { stab: 10, pop: -10 }, badge: 'b_spy' }, 
              no: { label: "Investigar", desc: "Transparência", eff: { pop: 10, stab: -10 } } }
        ];

        // EPIC EVENTS - Overpowered, 8% chance, Special UI
        const EPIC_POOL = [
            { id: 'e_city', text: "MILAGRE ARQUEOLÓGICO: Um terremoto revelou uma Cidade de Ouro Perdida intacta.", isEpic: true,
              yes: { label: "Aprovar", desc: "Focar em Turismo Global", eff: { eco: 30, pop: 20 } },
              no: { label: "Vetar", desc: "Explorar tesouros ocultos", eff: { eco: 50, pop: -10 } } },

            { id: 'e_alien', text: "CONTATO IMEDIATO: Uma nave pousou no planalto central. Eles oferecem tecnologia.", isEpic: true,
              yes: { label: "Aceitar", desc: "Tecnologia infinita", eff: { eco: 40, stab: 20 } },
              no: { label: "Recusar", desc: "O povo teme o desconhecido", eff: { stab: 40, pop: 10 } } },
              
            { id: 'e_lotto', text: "SORTE GRANDE: Reservas massivas de Lítio encontradas em todo o país.", isEpic: true,
              yes: { label: "Estatizar", desc: "O povo é dono", eff: { eco: 25, pop: 25 } },
              no: { label: "Privatizar", desc: "Eficiência máxima", eff: { eco: 60, pop: -20 } } }
        ];

        const STAT_RANGES = {
            eco: [ {l:20, t:"Colapso", c:"text-red-600"}, {l:40, t:"Frágil", c:"text-red-400"}, {l:60, t:"Estável", c:"text-blue-300"}, {l:80, t:"Forte", c:"text-green-400"}, {l:101, t:"Potência", c:"text-gold-500"} ],
            pop: [ {l:20, t:"Revolta", c:"text-red-600"}, {l:40, t:"Baixa", c:"text-red-400"}, {l:60, t:"Dividida", c:"text-blue-300"}, {l:80, t:"Alta", c:"text-green-400"}, {l:101, t:"Ídolo", c:"text-gold-500"} ],
            stab: [ {l:20, t:"Caos", c:"text-red-600"}, {l:40, t:"Instável", c:"text-red-400"}, {l:60, t:"Tensa", c:"text-blue-300"}, {l:80, t:"Segura", c:"text-green-400"}, {l:101, t:"Sólida", c:"text-gold-500"} ]
        };

        const getStat = (k, v) => STAT_RANGES[k].find(r => v < r.l) || STAT_RANGES[k][4];

        // --- GAME ENGINE ---
        const Game = {
            state: {
                room: null, me: null, host: false, round: 1, phase: 'lobby',
                players: [], news: { main: null, general: [] },
                chats: {}, 
            },
            peer: null, conn: [], hostConn: null,
            
            init: () => {
                const name = localStorage.getItem('pname');
                if(!name && router.cur !== 'home') router.nav('home');
            },

            calcEff: (val, type, player, isEpic) => {
                if(!val) return 0;
                // Get multiplier
                const mult = player.style ? (player.style.bonus[type] || 1) : 1;
                // Apply multiplier only if positive gain
                let final = val * (val > 0 ? mult : 1);
                
                // Round to nearest 5
                final = Math.round(final / 5) * 5;
                
                // Ensure non-zero if base was non-zero
                if(val !== 0 && final === 0) final = val > 0 ? 5 : -5;
                
                // Cap at 20 for non-epic (strictly -20 to 20)
                if(!isEpic) {
                    if(final > 20) final = 20;
                    if(final < -20) final = -20;
                }
                
                return final;
            },

            createRoom: (name) => {
                if(!name) return showToast("Nome obrigatório!", "error");
                localStorage.setItem('pname', name);
                const code = Math.random().toString(36).substr(2,4).toUpperCase();
                Game.state.room = code;
                Game.state.host = true;
                Game.state.me = 'host-'+Date.now();
                Game.state.players = [Game.createPlayer(Game.state.me, name)];
                Game.peer = new Peer('ip-pres-'+code);
                Game.peer.on('open', () => router.nav('lobby'));
                Game.peer.on('connection', c => {
                    Game.conn.push(c);
                    c.on('data', d => Game.handleData(d, c));
                    c.send({t:'SYNC', s:Game.state});
                });
            },

            joinRoom: (name, code) => {
                if(!name || !code) return showToast("Preencha tudo!", "error");
                localStorage.setItem('pname', name);
                Game.state.me = 'client-'+Date.now();
                Game.peer = new Peer();
                Game.peer.on('open', () => {
                    const c = Game.peer.connect('ip-pres-'+code.toUpperCase());
                    c.on('open', () => {
                        Game.hostConn = c;
                        c.send({ t:'JOIN', p:{ id: Game.state.me, name } });
                    });
                    c.on('data', d => Game.handleData(d));
                });
            },

            createPlayer: (id, name) => ({
                id, name, 
                stats:{eco:50, pop:50, stab:50}, 
                influence: 0,
                country:null, style:null, 
                decisionQueue: [], availableInvestments: [], projects: [], activeProjects: [], badges: [],
                govOptions: [], maxDecisions: 0,
                ready: false, investmentCount: 0,
                requests: [], notifications: 0,
                helpRequested: false
            }),

            handleData: (d, src) => {
                if(d.t === 'SYNC') {
                    Game.state = d.s;
                    Game.updateHUD(); // Always update HUD on sync
                    const me = Game.state.players.find(p => p.id === Game.state.me);
                    
                    if (Game.state.phase === 'reveal' && router.cur !== 'reveal') router.nav('reveal');
                    else if (Game.state.phase === 'game' && ['lobby','reveal','home'].includes(router.cur)) {
                        router.nav(me && me.style ? 'country' : 'setup');
                    }
                    
                    if(me) {
                        const relBadge = document.getElementById('badge-relations');
                        if(relBadge) relBadge.classList.toggle('hidden', (me.requests.length + (me.notifications || 0)) === 0);
                        
                        // Check Decision Badge (if turn not done)
                        const decBadge = document.getElementById('badge-decision');
                        if(decBadge) decBadge.classList.toggle('hidden', me.ready);
                    }

                    if(['country', 'map', 'decisions', 'relations', 'news'].includes(router.cur)) {
                        Game.updateHUD();
                        router.render();
                    }
                }
                if(Game.state.host) {
                    if(d.t === 'JOIN') {
                        if(!Game.state.players.find(p=>p.id===d.p.id)) {
                            Game.state.players.push(Game.createPlayer(d.p.id, d.p.name));
                            Game.sync();
                        }
                    }
                    if(d.t === 'ACT') Game.handleAct(d.a, d.p);
                }
            },

            updateHUD: () => {
                const me = Game.state.players.find(p => p.id === Game.state.me);
                if(me) {
                    document.getElementById('stat-eco').innerText = Math.round(me.stats.eco) + '%';
                    document.getElementById('stat-pop').innerText = Math.round(me.stats.pop) + '%';
                    document.getElementById('stat-stab').innerText = Math.round(me.stats.stab) + '%';
                    document.getElementById('stat-inf').innerText = me.influence || 0;
                }
                
                const rd = document.getElementById('round-display');
                if(rd) {
                    const year = Math.ceil(Game.state.round / 2);
                    const sem = (Game.state.round % 2 === 0) ? 2 : 1;
                    rd.innerText = `Ano ${year}/4 • Semestre ${sem}/2`;
                }
            },

            handleAct: (type, payload) => {
                const p = Game.state.players.find(pl => pl.id === payload.id);
                if(!p) return;
                
                if(type === 'GOV') {
                    const style = GOV_STYLES.find(s=>s.id===payload.style);
                    if(style) {
                        p.style = style;
                        // Apply Gov Style Initial Bonus explicitly
                        if(style.initial) {
                            if(style.initial.eco) p.stats.eco += style.initial.eco;
                            if(style.initial.pop) p.stats.pop += style.initial.pop;
                            if(style.initial.stab) p.stats.stab += style.initial.stab;
                        }
                        Game.clampStats(p);
                    }
                }
                
                if(type === 'DECIDE') {
                    if(p.decisionQueue.length > 0) {
                        const currentDecision = p.decisionQueue[0];
                        const chosenOption = payload.choice === 'yes' ? currentDecision.yes : currentDecision.no;

                        if(chosenOption.eff) {
                             const isEpic = currentDecision.isEpic || false;
                             Object.entries(chosenOption.eff).forEach(([k, v]) => {
                                 const finalVal = Game.calcEff(v, k, p, isEpic);
                                 p.stats[k] += finalVal;
                             });
                        }
                        
                        if(chosenOption.badge && !p.badges.includes(chosenOption.badge)) p.badges.push(chosenOption.badge);

                        p.decisionQueue.shift();
                        if(chosenOption.consequence) {
                            p.decisionQueue.unshift({
                                ...chosenOption.consequence,
                                isConsequence: true, id: 'cons_' + Date.now()
                            });
                            // Consequence doesnt increase max decisions, just extends the queue
                            p.maxDecisions++;
                        }
                        // removed automatic ready set
                        Game.clampStats(p);
                    }
                }
                
                if(type === 'READY') {
                    p.ready = true;
                    Game.checkTurnEnd();
                }

                if(type === 'INVEST') {
                    if(p.investmentCount >= 1) return;
                    const inv = INVESTMENT_POOL.find(i => i.id === payload.invId);
                    if(inv) {
                        let canBuy = true;
                        if(inv.cost) for(let k in inv.cost) if(p.stats[k] < inv.cost[k]) canBuy = false;
                        if(canBuy) {
                            if(inv.cost) for(let k in inv.cost) p.stats[k] -= inv.cost[k];
                            if(inv.gain) for(let k in inv.gain) p.stats[k] += inv.gain[k];
                            
                            p.investmentCount++;
                            Game.clampStats(p);
                        }
                    }
                }

                if(type === 'PROJECT') {
                    const proj = PROJECTS.find(pr => pr.id === payload.pid);
                    if(proj && !p.projects.includes(proj.id)) {
                        if(p.stats.eco >= (proj.cost.eco || 0) && p.stats.pop >= (proj.cost.pop || 0)) {
                            p.stats.eco -= (proj.cost.eco || 0);
                            p.stats.pop -= (proj.cost.pop || 0);
                            
                            // Initialize active project
                            if(!p.activeProjects) p.activeProjects = [];
                            p.activeProjects.push({
                                id: proj.id,
                                name: proj.name,
                                yield: proj.yield,
                                remaining: proj.duration,
                                maxDuration: proj.duration
                            });
                            
                            if(proj.badge && !p.badges.includes(proj.badge)) p.badges.push(proj.badge);
                            p.projects.push(proj.id);
                            Game.clampStats(p);
                        }
                    }
                }

                if(type === 'INVITE') {
                    const target = Game.state.players.find(pl => pl.id === payload.targetId);
                    if(target) {
                        target.requests.push({ id: Date.now(), type: payload.invType, from: p.id, fromName: p.name, fromCountry: p.country.name });
                    }
                }

                if(type === 'RESPOND') {
                    p.requests = p.requests.filter(r => r.id !== payload.reqId);
                }
                
                if(type === 'ASK_HELP') {
                    p.helpRequested = true;
                }
                
                if(type === 'SEND_HELP') {
                     const target = Game.state.players.find(pl => pl.id === payload.targetId);
                     if(target && target.helpRequested) {
                         const isTotal = payload.mode === 'total';
                         const cost = isTotal ? 20 : 10;
                         const infGain = isTotal ? 15 : 5;
                         const statGain = isTotal ? 25 : 10;
                         
                         if(p.stats.eco >= cost) {
                             p.stats.eco -= cost;
                             p.influence = (p.influence || 0) + infGain;
                             target.stats.eco += statGain;
                             target.stats.pop += statGain;
                             target.stats.stab += statGain;
                             target.helpRequested = false; // Resolved
                             
                             Game.clampStats(p);
                             Game.clampStats(target);
                             
                             // Add news event about it
                             Game.state.news.general.unshift({
                                 title: 'Ajuda Humanitária',
                                 text: `${p.country.name} enviou ajuda ${isTotal ? 'massiva' : 'emergencial'} para ${target.country.name}.`
                             });
                         }
                     }
                }

                if(type === 'CHAT') {
                    const key = [p.id, payload.targetId].sort().join('_');
                    if(!Game.state.chats[key]) Game.state.chats[key] = [];
                    Game.state.chats[key].push({ sender: p.id, text: payload.text, time: Date.now() });
                    const target = Game.state.players.find(pl => pl.id === payload.targetId);
                    if(target) target.notifications = (target.notifications || 0) + 1;
                }
                
                if(type === 'SPY') {
                    const target = Game.state.players.find(pl => pl.id === payload.targetId);
                    if(target) {
                        if(target.style && target.style.immune.includes('spy')) {
                            p.stats.eco -= 20;
                        } else {
                            target.stats.stab -= 15;
                            target.stats.pop -= 10;
                            p.stats.eco -= 20;
                        }
                        Game.clampStats(target);
                        Game.clampStats(p);
                    }
                }

                if(type === 'READ_NOTIFS') p.notifications = 0;

                Game.sync();
            },

            checkTurnEnd: () => {
                const activePlayers = Game.state.players.filter(p => p.country);
                if(activePlayers.length > 0 && activePlayers.every(p => p.ready)) {
                    setTimeout(() => Game.nextTurn(), 1000);
                }
            },

            nextTurn: () => {
                Game.state.round++;
                if(Game.state.round > 8) { /* End Game */ }
                
                Game.state.players.forEach(p => {
                    p.ready = false;
                    p.investmentCount = 0;
                    
                    // Process Active Projects (Long Term)
                    if(p.activeProjects && p.activeProjects.length > 0) {
                        for (let i = p.activeProjects.length - 1; i >= 0; i--) {
                            const ap = p.activeProjects[i];
                            if(ap.yield) {
                                if(ap.yield.eco) p.stats.eco += ap.yield.eco;
                                if(ap.yield.pop) p.stats.pop += ap.yield.pop;
                                if(ap.yield.stab) p.stats.stab += ap.yield.stab;
                            }
                            ap.remaining--;
                            if(ap.remaining <= 0) p.activeProjects.splice(i, 1);
                        }
                    }

                    // Consequences of Extremes
                    // < 20 (Crisis / Death Spiral)
                    if(p.stats.eco < 20) { p.stats.pop -= 10; p.stats.stab -= 10; } 
                    if(p.stats.pop < 20) { p.stats.stab -= 15; p.stats.eco -= 5; }
                    if(p.stats.stab < 20) { p.stats.eco -= 15; p.stats.pop -= 5; }

                    // > 80 (Side Effects of Excess)
                    if(p.stats.eco > 80) { p.stats.pop -= 5; } // Inequality
                    if(p.stats.pop > 80) { p.stats.eco -= 5; } // High Consumption / Populist Spending
                    if(p.stats.stab > 80) { p.stats.eco -= 5; } // Stagnation / Bureaucracy

                    const deck = [...DECISION_POOL].filter(d => d.id !== 'd_tax').sort(()=>0.5-Math.random());
                    
                    // First 2 semesters (Year 1) have more decisions
                    const count = Game.state.round <= 2 ? 4 : 3;
                    
                    p.decisionQueue = deck.slice(0, count);
                    
                    // 8% Chance for Epic Event (replaces last decision)
                    if (Math.random() < 0.08) {
                        const epic = EPIC_POOL[Math.floor(Math.random() * EPIC_POOL.length)];
                        if(p.decisionQueue.length > 0) {
                            p.decisionQueue[p.decisionQueue.length - 1] = epic;
                        }
                    }

                    p.maxDecisions = p.decisionQueue.length;
                    
                    const invDeck = [...INVESTMENT_POOL].sort(()=>0.5-Math.random());
                    p.availableInvestments = invDeck.slice(0, 4);

                    Game.clampStats(p);
                });
                Game.generateNews();
                Game.sync();
            },

            startMatch: () => {
                const playable = COUNTRIES.filter(c => !c.neutral);
                const shuffled = [...playable].sort(()=>0.5-Math.random());
                
                Game.state.players.forEach((p,i) => {
                    p.country = shuffled[i % shuffled.length];
                    p.activeProjects = [];
                    p.influence = 0;
                    
                    // Round 1: Tax + 3 Random = 4 Decisions
                    const randomDecs = [...DECISION_POOL].filter(d => d.id !== 'd_tax').sort(()=>0.5-Math.random()).slice(0,3);
                    p.decisionQueue = [DECISION_POOL.find(d => d.id === 'd_tax'), ...randomDecs];
                    
                    // 8% Chance for Epic Event (replaces last decision)
                    if (Math.random() < 0.08) {
                        const epic = EPIC_POOL[Math.floor(Math.random() * EPIC_POOL.length)];
                        p.decisionQueue[p.decisionQueue.length - 1] = epic;
                    }

                    p.maxDecisions = p.decisionQueue.length;
                    
                    const invDeck = [...INVESTMENT_POOL].sort(()=>0.5-Math.random());
                    p.availableInvestments = invDeck.slice(0, 4);
                    
                    // Assign 4 Random Gov Options
                    const govDeck = [...GOV_STYLES].sort(()=>0.5-Math.random());
                    p.govOptions = govDeck.slice(0, 4).map(g => g.id);
                });
                
                Game.state.news = {
                    main: { title: "Novos Presidentes Assumem o Poder", desc: "Uma nova era política começa na América do Sul. O mundo observa atentamente.", date: "Ano 1/4 • Semestre 1/2" },
                    general: [{ text: "Mercados globais reagem à posse dos novos líderes.", title: "Mundo" }]
                };
                
                Game.state.phase = 'reveal';
                Game.state.round = 1;
                router.nav('reveal');
                Game.sync();
                
                setTimeout(() => { Game.state.phase = 'game'; router.nav('setup'); Game.sync(); }, 4000);
            },
            
            generateNews: () => {
                const players = Game.state.players.filter(p => p.country);
                let main = null;
                let general = [...(Game.state.news.general || [])].slice(0, 5); // Keep old news
                
                const year = Math.ceil(Game.state.round / 2);
                const sem = (Game.state.round % 2 === 0) ? 2 : 1;
                const dateStr = `Ano ${year}/4 • Semestre ${sem}/2`;

                // Add round specific news
                if(Game.state.round === 1) {
                    main = { title: "Início de Mandato", desc: "Os novos presidentes definem as diretrizes de suas nações.", date: dateStr };
                    players.forEach(p => {
                         general.unshift({ title: p.country.name, text: `${p.country.name} declarou regime ${p.style.name}.` });
                    });
                } else {
                    // Find extremes
                    const sortedEco = [...players].sort((a,b) => b.stats.eco - a.stats.eco);
                    const bestEco = sortedEco[0];
                    const worstEco = sortedEco[sortedEco.length-1];

                    const sortedStab = [...players].sort((a,b) => b.stats.stab - a.stats.stab);
                    const worstStab = sortedStab[sortedStab.length-1];
                    
                    // Main News Decision
                    if (worstStab.stats.stab < 30) {
                        main = { title: `Caos em ${worstStab.country.name}`, desc: "Protestos violentos tomam as ruas. O governo perde o controle.", date: dateStr };
                    } else if (bestEco.stats.eco > 80) {
                        main = { title: `Milagre Econômico em ${bestEco.country.name}`, desc: "Analistas internacionais elogiam o crescimento recorde.", date: dateStr };
                    } else {
                        const randomEvents = [
                             { t: "Cimeira do Clima", d: "Líderes debatem metas de carbono." },
                             { t: "Tensão Comercial", d: "Tarifas de importação geram atrito no bloco." },
                             { t: "Avanço Tecnológico", d: "Novas startups impulsionam a região." }
                        ];
                        const ev = randomEvents[Math.floor(Math.random()*randomEvents.length)];
                        main = { title: ev.t, desc: ev.d, date: dateStr };
                    }

                    // General News Highlights
                    if(worstEco.stats.eco < 30) general.unshift({ title: "Economia", text: `Inflação dispara na ${worstEco.country.name}.` });
                    if(sortedEco[0].stats.pop > 80) general.unshift({ title: "Política", text: `Presidente da ${sortedEco[0].country.name} é aclamado pelo povo.` });
                    
                    players.forEach(p => {
                        if(p.activeProjects && p.activeProjects.length > 0) {
                            const ap = p.activeProjects[0];
                            if(Math.random() > 0.6) general.unshift({ title: p.country.name, text: `${p.country.name} avança com ${ap.name}.` });
                        }
                    });
                }

                Game.state.news = { main, general: general.slice(0, 15) };
            },

            selectDoctrine: (sid) => {
                const me = Game.state.players.find(p => p.id === Game.state.me);
                if(!me || !me.country) return;
                const div = document.createElement('div');
                div.className = "fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center transition-opacity duration-1000 opacity-0 pointer-events-none";
                div.innerHTML = `<div class="text-center"><p class="text-slate-500 uppercase tracking-[0.3em] text-sm mb-4 animate-fade-in">Assumindo controle de</p><h1 class="text-5xl md:text-7xl font-black text-gold-500 uppercase animate-intro-text leading-tight drop-shadow-2xl px-4">${me.country.name}</h1></div>`;
                document.body.appendChild(div);
                requestAnimationFrame(() => div.classList.remove('opacity-0'));
                setTimeout(() => {
                    Game.act('GOV', {style: sid}); 
                    router.navigate('country');
                    setTimeout(() => { div.classList.add('opacity-0'); setTimeout(() => div.remove(), 1000); }, 500); 
                }, 2500);
            },

            resolveDecision: (choice) => Game.act('DECIDE', { choice: choice }),
            confirmReady: () => Game.act('READY', {}),
            buyInvestment: (invId) => Game.act('INVEST', { invId: invId }),
            buyProject: (pid) => { Game.act('PROJECT', { pid: pid }); document.getElementById('modal-overlay').classList.add('hidden'); },
            sendInvite: (type, targetId) => { showToast('Convite enviado!'); Game.act('INVITE', { invType: type, targetId }); document.getElementById('modal-overlay').classList.add('hidden'); },
            sendChat: (targetId, text) => { if(!text) return; Game.act('CHAT', { targetId, text }); document.getElementById('chat-input').value = ''; },
            sendSpy: (targetId) => { showToast('Operação de Fake News iniciada...'); Game.act('SPY', { targetId }); document.getElementById('modal-overlay').classList.add('hidden'); },
            askHelp: () => { Game.act('ASK_HELP', {}); showToast('Pedido de ajuda enviado!'); router.render(); },
            sendHelp: (targetId, mode) => { Game.act('SEND_HELP', {targetId, mode}); showToast('Ajuda enviada!'); document.getElementById('modal-overlay').classList.add('hidden'); },
            respondRequest: (reqId, response) => { showToast(response === 'yes' ? 'Aceito!' : 'Recusado'); Game.act('RESPOND', { reqId, response }); router.render(); },
            clampStats: (p) => { ['eco','pop','stab'].forEach(k => p.stats[k] = Math.max(0, Math.min(100, p.stats[k]))); },
            sync: () => { Game.save(); Game.conn.forEach(c => c.send({t:'SYNC', s:Game.state})); Game.updateHUD(); router.render(); },
            save: () => localStorage.setItem('pres_save', JSON.stringify(Game.state)),
            exitGame: () => { localStorage.removeItem('pres_save'); location.reload(); },
            act: (type, payload) => {
                const req = { t:'ACT', a:type, p:{ ...payload, id:Game.state.me } };
                if(Game.state.host) Game.handleAct(type, { ...payload, id:Game.state.me });
                else if(Game.hostConn) Game.hostConn.send(req);
            }
        };

        const router = {
            cur: 'home',
            newsTab: 'main', 
            navigate: (v) => { router.nav(v); },
            nav: (v) => { 
                router.cur = v; 
                router.render(); 
                Game.updateHUD();
                
                const hud = ['country','map','decisions','relations','news'].includes(v);
                const header = document.getElementById('game-header');
                const nav = document.getElementById('game-nav');
                const container = document.getElementById('app-container');

                if(hud) {
                    header.classList.remove('hidden');
                    nav.classList.remove('hidden');
                    container.classList.add('has-nav');
                    const me = Game.state.players.find(p => p.id === Game.state.me);
                    if(me && me.country) document.getElementById('header-country').innerText = me.country.name;
                    if(v === 'relations') Game.act('READ_NOTIFS', {});
                } else {
                    header.classList.add('hidden');
                    nav.classList.add('hidden');
                    container.classList.remove('has-nav');
                }
                document.querySelectorAll('.nav-btn').forEach(b => {
                    if(b.onclick.toString().includes(`'${v}'`)) b.classList.add('text-gold-500', 'opacity-100');
                    else b.classList.remove('text-gold-500', 'opacity-100');
                });
            },
            render: () => {
                const c = document.getElementById('app-container');
                c.innerHTML = '';
                if(router.cur === 'home') renderHome(c);
                else if(router.cur === 'lobby') renderLobby(c);
                else if(router.cur === 'reveal') renderReveal(c);
                else if(router.cur === 'setup') renderSetup(c);
                else if(router.cur === 'country') renderCountry(c);
                else if(router.cur === 'map') renderMap(c);
                else if(router.cur === 'decisions') renderDecisions(c);
                else if(router.cur === 'relations') renderRelations(c);
                else if(router.cur === 'news') renderNews(c);
                lucide.createIcons();
            }
        };

        // --- VIEWS ---
        function renderHome(c) {
            c.innerHTML = `<div class="h-full flex flex-col justify-center items-center p-6 animate-fade-in"><i data-lucide="globe-2" class="w-20 h-20 text-gold-500 mb-4"></i><h1 class="text-3xl font-black text-center mb-8">IMPÉRIO DOS<br><span class="text-gold-500">PRESIDENTES</span></h1><div class="w-full max-w-xs space-y-4"><input id="inp-name" class="w-full bg-slate-800 p-4 rounded-xl border border-slate-600 focus:border-gold-500 outline-none" placeholder="Seu Nome" value="${localStorage.getItem('pname')||''}"><button onclick="Game.createRoom(document.getElementById('inp-name').value)" class="w-full bg-gold-500 text-dark-900 font-bold py-4 rounded-xl">Criar Sala</button><div class="flex gap-2"><input id="inp-code" class="w-24 bg-slate-800 text-center p-4 rounded-xl border border-slate-600 uppercase" placeholder="COD"><button onclick="Game.joinRoom(document.getElementById('inp-name').value, document.getElementById('inp-code').value)" class="flex-1 bg-blue-600 font-bold py-4 rounded-xl">Entrar</button></div></div></div>`;
        }
        function renderLobby(c) {
            c.innerHTML = `<div class="h-full p-6 pt-20 flex flex-col animate-slide-up"><div class="text-center mb-8"><p class="text-slate-400 text-xs uppercase">Código da Sala</p><h2 class="text-5xl font-mono font-bold tracking-widest text-white select-all">${Game.state.room}</h2></div><div class="flex-1 space-y-2 overflow-y-auto"><h3 class="font-bold text-slate-400 mb-2">Jogadores (${Game.state.players.length})</h3>${Game.state.players.map(p => `<div class="bg-slate-800 p-4 rounded-xl flex items-center gap-3 border border-slate-700"><div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i data-lucide="user" class="w-4 h-4"></i></div><span class="font-bold">${p.name}</span></div>`).join('')}</div>${Game.state.host ? `<button onclick="Game.startMatch()" class="mt-6 w-full bg-green-600 py-4 rounded-xl font-bold text-white shadow-lg shrink-0">INICIAR JOGO</button>` : `<p class="text-center text-slate-500 mt-6 animate-pulse shrink-0">Aguardando Host...</p>`}</div>`;
        }
        function renderReveal(c) {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            c.innerHTML = `<div class="h-full flex flex-col justify-center items-center p-6 bg-black z-50"><div class="text-slate-500 uppercase tracking-widest mb-4 font-bold animate-pulse">Você vai governar</div><i data-lucide="flag" class="w-24 h-24 text-white mb-6 animate-zoom-in"></i><h1 class="text-5xl font-black text-gold-500 text-center uppercase animate-slide-up leading-tight">${me.country.name}</h1></div>`;
        }
        function renderSetup(c) {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            if(!me || !me.country) return;
            
            // Limit to 4 options (use stored options or fallback to first 4)
            const availableIds = me.govOptions && me.govOptions.length ? me.govOptions : GOV_STYLES.map(g=>g.id).slice(0,4);
            const options = availableIds.map(id => GOV_STYLES.find(g => g.id === id)).filter(Boolean);

            const statKeys = { eco: 'Economia', pop: 'Popularidade', stab: 'Estabilidade' };
            c.innerHTML = `<div class="h-full flex flex-col p-4 animate-fade-in bg-dark-900"><div class="text-center mb-4 shrink-0"><h2 class="text-xl font-black text-white uppercase tracking-widest">Escolha a Doutrina</h2><p class="text-slate-400 text-xs">Futuro de: <span class="text-gold-500 font-bold">${me.country.name}</span></p></div><div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3 pb-8 overflow-y-auto">${options.map(s => {
                const bonusHtml = Object.entries(s.initial).map(([k, v]) => {
                    const color = v > 0 ? 'text-green-400 bg-green-900/30' : 'text-red-400 bg-red-900/30';
                    const sign = v > 0 ? '+' : '';
                    return `<div class="px-2 py-1 rounded text-[10px] font-bold ${color}">${statKeys[k]} ${sign}${v}</div>`;
                }).join('');
                return `<button onclick="Game.selectDoctrine('${s.id}')" class="bg-slate-800 border border-slate-700 hover:border-gold-500 active:scale-95 transition-all rounded-xl p-3 flex flex-col items-center text-center group relative overflow-hidden"><div class="absolute inset-0 bg-gold-500/5 opacity-0 group-hover:opacity-100 transition-opacity"></div><div class="text-gold-500 font-bold uppercase text-lg mb-1 leading-none">${s.name}</div><p class="text-slate-400 text-xs mb-3 leading-tight min-h-[2.5em]">${s.desc}</p><div class="flex flex-wrap gap-1 justify-center">${bonusHtml}</div></button>`;
            }).join('')}</div></div>`;
        }
        
        function renderCountry(c) {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            if(!me || !me.country) return;

            const badgeHtml = me.badges.length ? me.badges.map(bid => {
                const b = BADGES.find(x => x.id === bid);
                return `<div onclick="openBadge('${bid}')" class="w-8 h-8 rounded-full ${b.bg} border border-slate-600 flex items-center justify-center cursor-pointer shadow-lg hover:scale-110 transition-transform"><i data-lucide="${b.icon}" class="w-4 h-4 text-white"></i></div>`;
            }).join('') : '<span class="text-xs text-slate-600">Sem insígnias conquistadas.</span>';

            const activeProjectsHtml = me.activeProjects && me.activeProjects.length > 0 
                ? me.activeProjects.map(ap => {
                    const yieldText = Object.entries(ap.yield || {}).map(([k,v]) => `+${v} ${k.toUpperCase()}`).join(', ');
                    return `
                    <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex justify-between items-center relative overflow-hidden">
                        <div class="absolute bottom-0 left-0 h-1 bg-green-500 transition-all" style="width: ${(ap.remaining / ap.maxDuration) * 100}%"></div>
                        <div>
                            <div class="font-bold text-white text-sm">${ap.name}</div>
                            <div class="text-[10px] text-green-400 font-bold">Rende: ${yieldText}</div>
                        </div>
                        <div class="text-right">
                             <div class="text-[10px] text-slate-400 font-bold uppercase">Restam</div>
                             <div class="font-bold text-white">${ap.remaining} Sem</div>
                        </div>
                    </div>`;
                }).join('') 
                : `<p class="text-slate-500 text-sm italic text-center py-2">Nenhum projeto ativo.</p>`;

            // Check for Crisis
            const isCrisis = me.stats.eco < 20 || me.stats.pop < 20 || me.stats.stab < 20;

            c.innerHTML = `
            <div class="p-6 space-y-6 animate-slide-up pb-32">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl border border-slate-700 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="flag" class="w-32 h-32"></i></div>
                    <h2 class="text-3xl font-black text-white relative z-10">${me.country.name}</h2>
                    <p class="text-gold-500 font-bold uppercase tracking-wider relative z-10 text-sm mb-4">${me.style ? me.style.name : 'Sem Doutrina'}</p>
                    <div class="flex gap-2 relative z-10 mb-6 flex-wrap">${badgeHtml}</div>
                    <div class="space-y-4 relative z-10">${renderMyStat('Economia', me.stats.eco, 'eco')}${renderMyStat('Popularidade', me.stats.pop, 'pop')}${renderMyStat('Estabilidade', me.stats.stab, 'stab')}</div>
                </div>
                ${isCrisis && !me.helpRequested ? 
                    `<div class="bg-red-900/20 border border-red-600 rounded-2xl p-4 text-center animate-pulse">
                        <p class="text-red-400 font-bold text-sm mb-2">⚠ ESTADO CRÍTICO DETECTADO</p>
                        <p class="text-slate-300 text-xs mb-4">Sua nação está colapsando. Peça ajuda internacional.</p>
                        <button onclick="Game.askHelp()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-xl w-full">PEDIR AJUDA IMEDIATA</button>
                    </div>` 
                : ''}
                ${me.helpRequested ? 
                    `<div class="bg-yellow-900/20 border border-yellow-600 rounded-2xl p-4 text-center">
                        <p class="text-yellow-400 font-bold text-sm mb-2">📡 SINAL DE SOCORRO ATIVO</p>
                        <p class="text-slate-300 text-xs">Aguardando resposta da comunidade internacional...</p>
                    </div>` 
                : ''}
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-slate-300">Projetos Nacionais</h3>
                        <button onclick="openProjectModal()" class="text-xs bg-gold-600 text-black font-bold px-3 py-1.5 rounded hover:bg-gold-500 transition-colors shadow">+ Novo</button>
                    </div>
                    <div class="space-y-2">
                        ${activeProjectsHtml}
                    </div>
                </div>
            </div>`;
        }

        function renderDecisions(c) {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            const d = me.decisionQueue[0];
            const remaining = me.decisionQueue.length;

            let decisionHtml = '';
            if (me.ready) {
                decisionHtml = `
                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 text-center mb-8">
                        <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                            <i data-lucide="hourglass" class="w-8 h-8 text-gold-500"></i>
                        </div>
                        <h3 class="font-bold text-white">Aguardando...</h3>
                        <p class="text-slate-400 text-sm mt-2">Esperando outros presidentes.</p>
                    </div>`;
            } else if (!d && !me.ready) {
                // All decisions done, show "End Semester" button
                 decisionHtml = `
                    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700 text-center mb-8">
                        <h3 class="font-bold text-white text-xl mb-4">Mandato Concluído</h3>
                        <p class="text-slate-400 text-sm mb-6">Todas as decisões deste semestre foram tomadas. Revise seus investimentos e finalize.</p>
                        <button onclick="Game.confirmReady()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-105">
                            Encerrar Semestre
                        </button>
                    </div>`;
            } else {
                const isEpic = d.isEpic;
                const isConsequence = d.isConsequence || d.tag === "Consequência";
                
                // Styling Logic
                let mainBg = 'bg-slate-800 border-slate-700';
                let tagColor = isConsequence ? 'bg-red-600' : 'bg-gold-500';
                let tagText = isConsequence ? '⚠️ CONSEQUÊNCIA' : `DECISÃO ${me.maxDecisions - remaining + 1}/${me.maxDecisions}`;
                let textColor = 'text-white';
                let btnYesClass = 'bg-slate-900 border-slate-700 hover:border-green-500';
                let btnNoClass = 'bg-slate-900 border-slate-700 hover:border-red-500';

                // Epic Styling Override
                if (isEpic) {
                    mainBg = 'bg-gradient-to-r from-purple-600 to-pink-600 border-purple-400';
                    tagColor = 'bg-white/20 backdrop-blur';
                    tagText = '✨ EVENTO ÉPICO';
                    textColor = 'text-yellow-300';
                    btnYesClass = 'bg-purple-900/60 border-purple-400 hover:bg-purple-800';
                    btnNoClass = 'bg-pink-900/60 border-pink-400 hover:bg-pink-800';
                } else if (isConsequence) {
                    mainBg = 'bg-slate-800 border-red-500';
                }

                const renderBtnEff = (eff) => Object.entries(eff).map(([k,v]) => {
                     // Check gov modifiers for display
                     const val = Game.calcEff(v, k, me, isEpic);
                     const badgeBg = val > 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400';
                     return `<span class="text-[10px] font-black px-1.5 py-0.5 rounded ${badgeBg} ml-1 whitespace-nowrap">${k.toUpperCase()} ${val>0?'+':''}${val}</span>`;
                }).join('');

                decisionHtml = `
                    <div class="${mainBg} rounded-2xl p-6 shadow-2xl relative border flex flex-col mb-8 animate-slide-up overflow-hidden">
                         ${isEpic ? '<div class="absolute top-0 right-0 p-6 opacity-20"><i data-lucide="sparkles" class="w-32 h-32 text-white"></i></div>' : ''}
                         <div class="absolute -top-3 left-6 ${tagColor} text-white text-[10px] font-black px-3 py-1 rounded shadow-lg uppercase tracking-widest relative z-10">
                            ${isEpic ? '<i data-lucide="sparkles" class="w-3 h-3 inline mr-1"></i>' : ''}
                            ${tagText}
                         </div>
                        <p class="text-lg font-bold ${textColor} mb-6 mt-4 leading-snug relative z-10">${d.text}</p>
                        <div class="space-y-3 relative z-10">
                            <button onclick="Game.resolveDecision('yes')" class="w-full ${btnYesClass} border p-4 rounded-xl text-left group transition-all">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-green-400 font-black uppercase text-xs tracking-wider">${d.yes.label}</span>
                                    <div class="flex flex-wrap justify-end gap-1">${renderBtnEff(d.yes.eff)}</div>
                                </div>
                                <p class="text-slate-400 text-xs">${d.yes.desc}</p>
                            </button>
                            <button onclick="Game.resolveDecision('no')" class="w-full ${btnNoClass} border p-4 rounded-xl text-left group transition-all">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-red-400 font-black uppercase text-xs tracking-wider">${d.no.label}</span>
                                    <div class="flex flex-wrap justify-end gap-1">${renderBtnEff(d.no.eff)}</div>
                                </div>
                                <p class="text-slate-400 text-xs">${d.no.desc}</p>
                            </button>
                        </div>
                    </div>`;
            }

            const investmentsHtml = me.availableInvestments.map(inv => {
                const canAfford = Object.entries(inv.cost || {}).every(([k,v]) => me.stats[k] >= v);
                const limitReached = me.investmentCount >= 1;
                const active = canAfford && !limitReached;

                const costHtml = Object.entries(inv.cost || {}).map(([k,v]) => `<span class="text-[10px] font-bold text-red-400">-${v} ${k.toUpperCase()}</span>`).join(' ');
                const gainHtml = Object.entries(inv.gain || {}).map(([k,v]) => `<span class="text-[10px] font-bold text-green-400">+${v} ${k.toUpperCase()}</span>`).join(' ');

                return `
                <button onclick="${active ? `Game.buyInvestment('${inv.id}')` : ''}" class="bg-slate-800 border ${active ? 'border-slate-700 hover:border-gold-500' : 'border-slate-800 opacity-40 cursor-not-allowed'} p-4 rounded-xl text-left transition-all relative">
                    ${!limitReached ? '' : '<div class="absolute inset-0 bg-black/50 rounded-xl flex items-center justify-center text-xs font-bold uppercase text-white">Limite atingido</div>'}
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-white text-sm">${inv.name}</span>
                        <i data-lucide="${active ? 'plus-circle' : 'lock'}" class="w-4 h-4 ${active ? 'text-gold-500' : 'text-slate-500'}"></i>
                    </div>
                    <p class="text-xs text-slate-400 mb-3">${inv.desc}</p>
                    <div class="flex justify-between items-center bg-slate-900/50 p-2 rounded-lg">
                        <div class="flex gap-2">${costHtml}</div>
                        <i data-lucide="arrow-right" class="w-3 h-3 text-slate-600"></i>
                        <div class="flex gap-2">${gainHtml}</div>
                    </div>
                </button>`;
            }).join('');

            c.innerHTML = `
                <div class="p-4 md:p-6 animate-slide-up pb-32">
                    <h2 class="text-2xl font-bold text-white mb-6">Sala de Decisões</h2>
                    ${decisionHtml}
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="briefcase" class="w-5 h-5 text-gold-500"></i>
                            <h3 class="font-bold text-slate-300">Ações Governamentais</h3>
                        </div>
                        <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">${me.investmentCount}/1</span>
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        ${investmentsHtml}
                    </div>
                </div>`;
        }

        function renderRelations(c) {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            const others = Game.state.players.filter(p => p.id !== Game.state.me);

            const requestsHtml = me.requests.map(r => `
                <div class="bg-slate-700 p-4 rounded-xl mb-4 border-l-4 border-gold-500 animate-slide-up">
                    <p class="text-sm font-bold text-white mb-1"><span class="text-gold-500">${r.fromName}</span> (${r.fromCountry})</p>
                    <p class="text-xs text-slate-300 mb-3">Enviou um convite de <span class="uppercase font-bold">${r.type === 'alliance' ? 'Aliança' : 'Parceria'}</span>.</p>
                    <div class="flex gap-2">
                        <button onclick="Game.respondRequest(${r.id}, 'yes')" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded text-xs font-bold">Aceitar</button>
                        <button onclick="Game.respondRequest(${r.id}, 'no')" class="flex-1 bg-red-600 hover:bg-red-500 py-2 rounded text-xs font-bold">Recusar</button>
                    </div>
                </div>
            `).join('');

            const myProfileHtml = `
            <button onclick="openDetails('${me.country.id}')" class="w-full bg-slate-800/50 p-4 rounded-xl flex items-center justify-between border border-dashed border-slate-700 hover:border-slate-500 transition-colors mb-6">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center border border-slate-600">
                        <i data-lucide="user" class="w-5 h-5 text-gold-500"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-bold text-white">Você (${me.country.name})</p>
                        <p class="text-xs text-slate-400">Ver Perfil Público</p>
                    </div>
                </div>
            </button>`;

            const listHtml = others.map(p => {
                const key = [me.id, p.id].sort().join('_');
                const chatHistory = Game.state.chats[key] || [];
                const lastMsg = chatHistory[chatHistory.length - 1];
                const isCrisis = p.stats.eco < 20 || p.stats.pop < 20 || p.stats.stab < 20;

                return `
                <button onclick="openRelationModal('${p.id}')" class="w-full bg-slate-800 p-4 rounded-xl flex items-center justify-between border ${isCrisis ? 'border-red-500 animate-pulse' : 'border-slate-700 hover:border-gold-500'} transition-colors group relative">
                    ${isCrisis ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></div>' : ''}
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center border border-slate-600 group-hover:border-gold-500 transition-colors">
                            <i data-lucide="flag" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="text-left">
                            <p class="font-bold text-white">${p.country.name}</p>
                            <p class="text-xs ${isCrisis ? 'text-red-400 font-bold' : 'text-slate-400'}">${p.name} ${isCrisis ? '⚠ SOS' : ''}</p>
                        </div>
                    </div>
                    ${lastMsg ? '<i data-lucide="message-square" class="w-4 h-4 text-gold-500"></i>' : '<i data-lucide="chevron-right" class="w-4 h-4 text-slate-600"></i>'}
                </button>`;
            }).join('');

            c.innerHTML = `
            <div class="p-6 animate-slide-up pb-32">
                <h2 class="text-2xl font-bold text-white mb-6">Relações Exteriores</h2>
                ${requestsHtml}
                ${myProfileHtml}
                <div class="space-y-3 mt-4">
                    ${listHtml}
                </div>
            </div>`;
        }

        function renderNews(c) {
            const news = Game.state.news;
            const tab = router.newsTab;

            let contentHtml = '';
            if(tab === 'main') {
                 if (news.main) {
                    contentHtml = `
                    <div onclick="openNewsDetail('main')" class="cursor-pointer group bg-slate-800/50 border-l-4 border-gold-500 p-6 hover:bg-slate-800 transition-colors rounded-r-xl">
                        <div class="flex justify-between items-start mb-2">
                             <span class="text-gold-500 text-[10px] font-black uppercase tracking-widest">Manchete Oficial</span>
                             <span class="text-slate-500 text-[10px] uppercase font-bold">${news.main.date}</span>
                        </div>
                        <h2 class="text-xl md:text-2xl font-bold text-white leading-tight mb-4 group-hover:text-gold-400 transition-colors">${news.main.title}</h2>
                        <p class="text-slate-400 text-sm leading-relaxed">${news.main.desc}</p>
                    </div>`;
                } else { contentHtml = `<div class="p-6 text-center text-slate-500">Sem manchetes.</div>`; }
            } else {
                 if (news.general && news.general.length > 0) {
                    contentHtml = `<div class="bg-slate-900/50 rounded-xl overflow-hidden border border-slate-700/50 divide-y divide-slate-700/50">
                        ${news.general.map((n, idx) => `
                        <div onclick="openNewsDetail(${idx})" class="p-4 hover:bg-slate-800/50 transition-colors cursor-pointer group flex gap-4">
                             <div class="mt-1.5 w-1.5 h-1.5 rounded-full bg-slate-500 group-hover:bg-gold-500 shrink-0 transition-colors"></div>
                             <div>
                                <p class="text-[10px] font-bold text-slate-500 uppercase">${n.title || 'Geral'}</p>
                                <p class="text-sm text-slate-300 font-medium group-hover:text-white">${n.text}</p>
                             </div>
                        </div>`).join('')}
                    </div>`;
                } else { contentHtml = `<div class="p-6 text-center text-slate-500">Nada a relatar.</div>`; }
            }

            c.innerHTML = `
                <div class="p-4 md:p-6 animate-slide-up pb-32">
                    <h1 class="text-3xl font-black text-white mb-6">Central de Notícias</h1>
                    <div class="flex bg-slate-900/50 rounded-lg p-1 mb-6 border border-slate-700/50">
                        <button onclick="router.newsTab='main'; router.render()" class="flex-1 py-2 text-sm font-bold rounded-md transition-all ${tab==='main'?'bg-slate-700 text-white shadow':'text-slate-400 hover:text-white'}">Principais</button>
                        <button onclick="router.newsTab='general'; router.render()" class="flex-1 py-2 text-sm font-bold rounded-md transition-all ${tab==='general'?'bg-slate-700 text-white shadow':'text-slate-400 hover:text-white'}">Geral</button>
                    </div>
                    ${contentHtml}
                </div>`;
        }
        
        function renderMyStat(l, v, t) { const m = getStat(t, v); return `<div><div class="flex justify-between text-xs font-bold uppercase mb-1"><span class="text-slate-400">${l}</span><span class="${m.c}">${v}%</span></div><div class="h-2 bg-slate-950 rounded-full overflow-hidden"><div class="h-full bg-current ${m.c} transition-all duration-500" style="width:${v}%"></div></div></div>`; }
        function renderMap(c) { 
            const meId = Game.state.me; 
            const svg = COUNTRIES.map(y => { 
                const o = Game.state.players.find(p => p.country && p.country.id === y.id); 
                let f='#334155', s='#475569', z=1; 
                let badgeIcon = '';
                let crisisClass = '';

                if(o) { 
                    if(o.id === meId) { f='#1d4ed8'; s='#60a5fa'; z=10; } 
                    else { f='#ca8a04'; s='#facc15'; z=5; } 
                    
                    if(o.stats.eco < 20 || o.stats.pop < 20 || o.stats.stab < 20) {
                         crisisClass = 'crisis-glow';
                         s = '#ef4444';
                    }

                    // Render Badge on Map
                    if (o.badges.length > 0) {
                        const lastBadge = BADGES.find(b => b.id === o.badges[o.badges.length-1]);
                        if(lastBadge) {
                            badgeIcon = `
                                <g transform="translate(${y.center.x + 10}, ${y.center.y - 10})" onclick="openBadge('${lastBadge.id}')" class="cursor-pointer hover:scale-125 transition-transform">
                                    <circle r="8" fill="#1e293b" stroke="#fbbf24" stroke-width="1.5"/>
                                    <text x="0" y="3" text-anchor="middle" font-size="8" fill="white">★</text>
                                </g>
                            `;
                        }
                    }
                } 
                return `<g><path d="${y.path}" fill="${f}" stroke="${s}" class="country-path ${crisisClass}" onclick="openDetails('${y.id}')" style="z-index:${z}" />${badgeIcon}</g>`; 
            }).join(''); 
            c.innerHTML = `<div class="h-full flex items-center justify-center bg-dark-900 relative overflow-hidden"><h2 class="absolute top-6 left-6 text-4xl font-black text-slate-800 z-0 select-none">AMÉRICA<br>DO SUL</h2><svg viewBox="0 0 350 400" class="w-full max-w-lg drop-shadow-2xl z-10" style="max-height: 80vh;">${svg}</svg></div>`; 
        }

        // --- GLOBAL UTILITIES ---
        window.openNewsDetail = function(id) { 
            const item = id === 'main' ? Game.state.news.main : Game.state.news.general[id];
            if(!item) return;
            document.getElementById('modal-content').innerHTML = `<h2 class="text-xl font-bold text-white mb-4">${item.title || item.text}</h2><p class="text-slate-400 text-sm mb-6">${item.desc || "Detalhes não disponíveis."}</p><button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="w-full py-3 bg-slate-700 rounded-xl font-bold">Fechar</button>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        };
        
        window.openBadge = function(bid) {
            const b = BADGES.find(x => x.id === bid);
            if(!b) return;
            document.getElementById('modal-content').innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full ${b.bg} flex items-center justify-center mx-auto mb-4 border-2 border-white"><i data-lucide="${b.icon}" class="w-8 h-8 text-white"></i></div>
                    <h2 class="text-xl font-bold ${b.color} mb-2">${b.name}</h2>
                    <p class="text-slate-300 text-sm mb-6">${b.desc}</p>
                </div>
                <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="w-full py-3 bg-slate-700 rounded-xl font-bold">Fechar</button>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
            lucide.createIcons();
        }

        window.openProjectModal = function() {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            const html = PROJECTS.map(p => {
                const owned = me.projects.includes(p.id);
                const canAfford = me.stats.eco >= (p.cost.eco||0) && me.stats.pop >= (p.cost.pop||0);
                const yieldText = Object.entries(p.yield).map(([k,v]) => `+${v} ${k.toUpperCase()}`).join(', ');

                return `
                <button onclick="${!owned && canAfford ? `Game.buyProject('${p.id}')` : ''}" class="w-full bg-slate-700 p-3 rounded-xl mb-2 flex justify-between items-center ${owned ? 'opacity-50' : canAfford ? 'hover:bg-slate-600' : 'opacity-40'}">
                    <div class="text-left">
                        <div class="font-bold text-white text-sm">${p.name} ${owned ? '(Ativo)' : ''}</div>
                        <div class="text-[10px] text-slate-400">Duração: ${p.duration} Semestres</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-red-400 font-bold">-${p.cost.eco} ECO</div>
                        <div class="text-[10px] text-green-400 font-bold">Rende: ${yieldText}</div>
                    </div>
                </button>`;
            }).join('');
            document.getElementById('modal-content').innerHTML = `<h2 class="text-xl font-bold text-white mb-4">Projetos Nacionais</h2><p class="text-xs text-slate-400 mb-4">Investimentos de longo prazo que rendem recursos todo semestre.</p>${html}<button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="mt-4 w-full py-3 bg-slate-800 rounded-xl font-bold text-slate-400">Cancelar</button>`;
            document.getElementById('modal-overlay').classList.remove('hidden');
        };

        window.openRelationModal = function(targetId) {
            const me = Game.state.players.find(p => p.id === Game.state.me);
            const target = Game.state.players.find(p => p.id === targetId);
            const key = [me.id, target.id].sort().join('_');
            const chatHistory = Game.state.chats[key] || [];

            const chatHtml = chatHistory.map(msg => 
                `<div class="mb-2 ${msg.sender === me.id ? 'text-right' : 'text-left'}">
                    <span class="inline-block px-2 py-1 rounded text-xs ${msg.sender === me.id ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300'}">${msg.text}</span>
                </div>`
            ).join('');

            // Check if target needs help
            const isCrisis = target.helpRequested;
            let actionButtons = '';
            
            if (isCrisis) {
                 actionButtons = `
                    <div class="col-span-2 bg-red-900/40 p-3 rounded-xl border border-red-500 mb-2">
                        <p class="text-red-400 font-bold text-xs mb-2 text-center uppercase">Pedido de Ajuda Ativo</p>
                        <div class="grid grid-cols-2 gap-2">
                             <button onclick="Game.sendHelp('${targetId}', 'partial')" class="bg-blue-600 p-2 rounded text-xs font-bold hover:bg-blue-500 flex flex-col items-center justify-center">
                                <span>Humanitária</span>
                                <span class="text-[9px] text-blue-200">-10 Eco / +5 Inf</span>
                             </button>
                             <button onclick="Game.sendHelp('${targetId}', 'total')" class="bg-gold-600 text-black p-2 rounded text-xs font-bold hover:bg-gold-500 flex flex-col items-center justify-center">
                                <span>Financeira</span>
                                <span class="text-[9px] text-black/70">-20 Eco / +15 Inf</span>
                             </button>
                        </div>
                    </div>`;
            } else {
                 actionButtons = `
                    <button onclick="Game.sendInvite('alliance', '${targetId}')" class="bg-indigo-600 p-2 rounded text-xs font-bold hover:bg-indigo-500">Aliança</button>
                    <button onclick="Game.sendInvite('partnership', '${targetId}')" class="bg-teal-600 p-2 rounded text-xs font-bold hover:bg-teal-500">Parceria</button>
                    <button onclick="Game.sendSpy('${targetId}')" class="bg-red-900/50 text-red-400 border border-red-900 p-2 rounded text-xs font-bold hover:bg-red-900/80 col-span-2">Espião de Fake News (-20 ECO)</button>
                 `;
            }

            document.getElementById('modal-content').innerHTML = `
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-white">${target.country.name}</h2>
                    <p class="text-xs text-gold-500 font-bold uppercase">${target.name}</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    ${actionButtons}
                </div>
                <div class="bg-slate-900 rounded-xl p-3 h-40 overflow-y-auto mb-2 border border-slate-700 flex flex-col-reverse">
                    <div id="chat-feed">${chatHtml}</div>
                </div>
                <div class="flex gap-2">
                    <input id="chat-input" class="flex-1 bg-slate-800 rounded px-3 text-sm outline-none border border-slate-700 focus:border-gold-500" placeholder="Mensagem...">
                    <button onclick="Game.sendChat('${targetId}', document.getElementById('chat-input').value)" class="bg-gold-500 text-black p-2 rounded"><i data-lucide="send" class="w-4 h-4"></i></button>
                </div>
                <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="mt-4 w-full py-3 bg-slate-800 rounded-xl font-bold text-slate-400">Fechar</button>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');
            lucide.createIcons();
        };

        window.openDetails = function(cid) { 
            const p = Game.state.players.find(pl => pl.country && pl.country.id === cid);
            const overlay = document.getElementById('modal-overlay');
            if(!p) return;
            const isMe = p.id === Game.state.me;
            
            const badgeHtml = p.badges.length ? p.badges.map(bid => {
                const b = BADGES.find(x => x.id === bid);
                return `<div onclick="openBadge('${bid}')" class="w-6 h-6 rounded-full ${b.bg} flex items-center justify-center cursor-pointer"><i data-lucide="${b.icon}" class="w-3 h-3 text-white"></i></div>`;
            }).join('') : '';

            document.getElementById('modal-content').innerHTML = `
                <h2 class="text-2xl font-black text-white text-center mb-1">${p.country.name}</h2>
                <p class="text-gold-500 font-bold text-sm text-center mb-4 uppercase tracking-wider">${p.name}</p>
                <div class="flex justify-center gap-2 mb-6">${badgeHtml}</div>
                ${!isMe ? `<div class="space-y-2 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                     <div class="flex justify-between text-xs font-bold uppercase"><span class="text-slate-500">Governo</span><span class="text-white">${p.style ? p.style.name : '?'}</span></div>
                     <div class="flex justify-between text-xs font-bold uppercase"><span class="text-slate-500">Situação</span><span class="${getStat('eco', p.stats.eco).c}">${getStat('eco', p.stats.eco).t}</span></div>
                </div>` : '<p class="text-center text-blue-300 text-sm">Território Soberano</p>'}
                <button onclick="document.getElementById('modal-overlay').classList.add('hidden')" class="mt-6 w-full py-3 bg-slate-700 rounded-xl font-bold">Fechar</button>
            `;
            overlay.classList.remove('hidden');
            lucide.createIcons();
        };

        window.showToast = function(msg, type='info') {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.className = `fixed top-28 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full font-bold shadow-lg transform transition-all duration-300 z-[100] flex items-center gap-2 ${type==='error'?'bg-red-600 text-white':'bg-white text-dark-900'}`;
            t.classList.remove('-translate-y-40', 'opacity-0');
            setTimeout(() => t.classList.add('-translate-y-40', 'opacity-0'), 3000);
        };
        window.addEventListener('load', () => { router.render(); });
    </script>
</body>
</html>