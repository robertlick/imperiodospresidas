<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presidentes da América do Sul</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: { 400: '#FACC15', 500: '#EAB308', 600: '#CA8A04' },
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        presidential: { blue: '#1e3a8a', red: '#991b1b', green: '#166534' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(16px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .country-path { transition: all 0.3s ease; cursor: pointer; stroke-width: 1.5; }
        .country-path:hover { filter: brightness(1.1); transform: scale(1.01); transform-origin: center; z-index: 10; }
        .news-item { border-left: 4px solid; }
        .news-real { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .news-fake { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); }
        .news-rumor { border-color: #eab308; background: rgba(234, 179, 8, 0.1); }
        .gov-card { transition: all 0.2s; }
        .gov-card:active { transform: scale(0.98); border-color: #EAB308; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- Top Bar -->
    <header id="game-header" class="h-16 flex items-center justify-between px-4 glass-panel z-20 shrink-0 hidden border-b border-slate-700">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center border border-slate-500">
                <i data-lucide="flag" class="w-4 h-4 text-white"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase leading-none">Presidente</span>
                <span class="font-bold text-sm text-white leading-tight truncate w-24" id="header-country">País</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Semestre</span>
                <span class="text-xl font-bold text-gold-500" id="round-display">1/8</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="flex-1 overflow-y-auto scroll-hide relative pb-24">
        <!-- Views injected by JS -->
    </main>

    <!-- Government Selection Overlay (Start Game) -->
    <div id="setup-overlay" class="fixed inset-0 bg-dark-900 z-[80] hidden flex flex-col p-6 overflow-hidden">
        <div class="text-center mb-6 animate-fade-in">
            <h1 class="text-2xl font-black text-white uppercase tracking-widest mb-1">Eleito!</h1>
            <p class="text-slate-400 text-sm">Parabéns, você assumiu a presidência <span id="setup-country-pre">da/do</span> <span id="setup-country-name" class="text-gold-500 font-bold text-lg">País</span>.</p>
            <p class="text-white font-bold mt-4">Como deseja governar seu país?</p>
        </div>
        <div id="setup-options" class="flex-1 overflow-y-auto space-y-3 pb-6 animate-slide-up scroll-hide">
            <!-- Options injected here -->
        </div>
    </div>

    <!-- Fullscreen Debate Modal -->
    <div id="debate-overlay" class="fixed inset-0 bg-presidential-blue z-[100] hidden flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-4xl font-black text-white mb-2 uppercase tracking-widest">Debate Continental</h1>
        <div class="w-full h-1 bg-white/20 mb-8 rounded-full overflow-hidden">
             <div id="debate-timer-bar" class="h-full bg-red-500 w-full transition-all duration-1000 ease-linear"></div>
        </div>
        
        <div id="debate-speaker-area" class="bg-white/10 p-6 rounded-2xl border border-white/20 w-full max-w-md backdrop-blur-lg mb-6">
            <p class="text-slate-300 text-xs uppercase mb-2">Com a palavra</p>
            <h2 class="text-3xl font-bold text-gold-400 mb-4" id="debate-speaker-name">BRASIL</h2>
            <div class="text-6xl font-mono text-white mb-4" id="debate-countdown">30</div>
            <p id="debate-topic" class="text-sm text-white italic">"Justifique a queda na economia..."</p>
        </div>

        <button onclick="Game.endSpeech()" id="btn-end-speech" class="w-full max-w-xs bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all hidden">
            ENCERRAR FALA
        </button>
        <p id="debate-wait-msg" class="text-slate-400 animate-pulse mt-4">Aguardando...</p>
    </div>

    <!-- Generic Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-dark-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-2xl p-6 relative animate-slide-up">
            <!-- Content -->
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-white text-dark-900 px-6 py-3 rounded-full font-bold shadow-lg transform -translate-y-20 transition-all duration-300 z-[60] flex items-center gap-2 pointer-events-none opacity-0">
        <i data-lucide="bell" class="w-5 h-5"></i>
        <span id="toast-message">Notificação</span>
    </div>

    <!-- Navbar -->
    <nav id="game-nav" class="h-20 glass-panel fixed bottom-0 w-full z-40 flex justify-around items-center pb-4 shrink-0 hidden">
        <button onclick="router.navigate('country')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <i data-lucide="landmark" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">País</span>
        </button>
        <button onclick="router.navigate('map')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <i data-lucide="map" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Mapa</span>
        </button>
        <button onclick="router.navigate('decisions')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <div class="relative">
                <i data-lucide="gavel" class="w-6 h-6"></i>
                <span id="badge-decision" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse hidden"></span>
            </div>
            <span class="text-[10px] font-bold">Decisões</span>
        </button>
        <button onclick="router.navigate('relations')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold">Relações</span>
        </button>
        <button onclick="router.navigate('news')" class="nav-btn flex flex-col items-center gap-1 p-2 w-16 opacity-60 hover:opacity-100 transition-all">
            <div class="relative">
                <i data-lucide="newspaper" class="w-6 h-6"></i>
                <span id="badge-news" class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full hidden"></span>
            </div>
            <span class="text-[10px] font-bold">Notícias</span>
        </button>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        const COUNTRIES = [
            { id: 've', name: 'Venezuela', path: 'M 90 20 L 150 30 L 140 70 L 90 80 Z' },
            { id: 'co', name: 'Colômbia', path: 'M 40 40 L 90 20 L 90 80 L 40 90 Z' },
            { id: 'pe', name: 'Peru', path: 'M 30 90 L 90 80 L 100 160 L 40 180 Z' },
            { id: 'br', name: 'Brasil', path: 'M 90 80 L 140 70 L 190 90 L 210 180 L 150 240 L 100 160 Z' },
            { id: 'cl', name: 'Chile', path: 'M 50 200 L 70 200 L 70 420 L 50 400 Z' },
            { id: 'ar', name: 'Argentina', path: 'M 80 200 L 150 240 L 120 400 L 70 420 L 70 200 Z' }
        ];

        const ALL_GOV_STYLES = [
            { id: 'populist', name: 'Populismo Carismático', desc: 'Discurso forte e promessas. Pop sobe fácil, Eco instável.', bonus: { pop: 20, eco: -10 } },
            { id: 'liberal', name: 'Liberal Econômico', desc: 'Mercado acima de tudo. Eco cresce rápido, Pop sensível a crises.', bonus: { eco: 20, pop: -10 } },
            { id: 'state', name: 'Estado Forte', desc: 'Centralizador. Estabilidade alta, espionagem eficiente.', bonus: { stab: 20 } },
            { id: 'technocrat', name: 'Tecnocracia', desc: 'Decisões técnicas. Erros punem mais, acertos dão bônus extra.', bonus: { eco: 10, stab: 10 } },
            { id: 'nationalist', name: 'Nacionalismo Econômico', desc: 'Proteção interna. Resiste a crises externas, cresce devagar.', bonus: { stab: 15, eco: -5 } },
            { id: 'diplomat', name: 'Diplomacia Estratégica', desc: 'Foco externo. Alianças rendem mais, traições custam caro.', bonus: { pop: 5 } },
            { id: 'welfare', name: 'Governo Assistencialista', desc: 'Bem-estar social. Pop alta, Eco lenta, resiste a crises sociais.', bonus: { pop: 25, eco: -15 } },
            { id: 'corporate', name: 'Governo Empresarial', desc: 'País como empresa. Investimentos altos, Fake News doem mais.', bonus: { eco: 25, pop: -20 } },
            { id: 'shadow', name: 'Autoritarismo Velado', desc: 'Controle discreto. Ocultar dados custa pouco.', bonus: { stab: 10 } },
            { id: 'federal', name: 'Federalismo Forte', desc: 'Poder distribuído. Crises menores, decisões com menos impacto extremo.', bonus: { stab: 25 } },
            { id: 'reformist', name: 'Reformismo Contínuo', desc: 'Mudança constante. Eventos frequentes, decisões menos punitivas.', bonus: { eco: 5, pop: 5 } },
            { id: 'isolationist', name: 'Isolacionismo', desc: 'Fechado. Imune a fake news externas, economia lenta.', bonus: { stab: 30, eco: -15 } },
            { id: 'media', name: 'Governo Midiático', desc: 'Controle narrativo. Notícias positivas valem dobro.', bonus: { pop: 10 } },
            { id: 'militarized', name: 'Governo Militarizado', desc: 'Ordem total. Estabilidade máxima, Pop cai em debates.', bonus: { stab: 35, pop: -15 } },
            { id: 'participatory', name: 'Democracia Participativa', desc: 'Guiado pelo povo. Ocultar dados é fatal, decisões populares dão bônus.', bonus: { pop: 15 } },
            { id: 'oligarchy', name: 'Oligarquia Econômica', desc: 'Elite no poder. Eco cresce sem Pop, crises políticas perigosas.', bonus: { eco: 30, pop: -30 } },
            { id: 'green', name: 'Governo Verde', desc: 'Sustentável. Imune a crises ambientais, crescimento lento.', bonus: { pop: 10, eco: -5 } },
            { id: 'pragmatist', name: 'Governo Pragmatista', desc: 'Sem ideologia. Adaptável, sem grandes bônus ou ônus.', bonus: { stab: 5, eco: 5, pop: 5 } },
            { id: 'religious', name: 'Governo Religioso', desc: 'Moral e tradição. Pop estável, escândalos morais devastadores.', bonus: { stab: 10, pop: 10 } },
            { id: 'crisis', name: 'Governo de Crise', desc: 'Assume no caos. Começa mal, viradas dão bônus enormes.', bonus: { eco: -20, pop: -20, stab: -20 } }
        ];

        // Format: { text, yes: { desc, effect }, no: { desc, effect } }
        const DECISIONS_POOL = [
            { 
                text: "Privatizar estatal de energia elétrica?", 
                yes: { desc: "Venda rápida gera caixa, mas tarifas podem subir.", effect: { eco: 15, pop: -10 } },
                no: { desc: "Mantém controle estatal e preços, mas aumenta dívida.", effect: { stab: 5, eco: -5 } }
            },
            { 
                text: "Aumentar salário mínimo acima da inflação?", 
                yes: { desc: "Aumenta poder de compra e felicidade, mas pressiona contas.", effect: { pop: 15, eco: -15 } },
                no: { desc: "Austeridade fiscal agrada mercado, mas povo reclama.", effect: { eco: 10, pop: -10 } }
            },
            { 
                text: "Censurar jornal opositor por 'Fake News'?", 
                yes: { desc: "Silencia críticas e aumenta controle, mas gera revolta.", effect: { stab: 15, pop: -20 } },
                no: { desc: "Mantém liberdade de imprensa, mas críticas continuam.", effect: { pop: 5, stab: -5 } }
            },
            { 
                text: "Aceitar empréstimo do FMI com juros altos?", 
                yes: { desc: "Dinheiro entra agora, mas soberania é afetada.", effect: { eco: 20, stab: -15 } },
                no: { desc: "Recusa ajuda externa. Crise continua, mas com orgulho.", effect: { stab: 10, eco: -10 } }
            },
            { 
                text: "Investir pesado em propaganda do governo?", 
                yes: { desc: "Melhora imagem artificialmente, custa caro.", effect: { pop: 10, eco: -5 } },
                no: { desc: "Economiza recursos, mas perde narrativa.", effect: { eco: 5 } }
            },
            {
                text: "Decretar Estado de Sítio preventivo?",
                yes: { desc: "Controle total das ruas, medo generalizado.", effect: { stab: 30, pop: -25, eco: -10 } },
                no: { desc: "Mantém normalidade democrática.", effect: { pop: 5 } }
            },
            {
                text: "Romper relações com superpotência rival?",
                yes: { desc: "Agrado ideológico, mas perde parceiro comercial.", effect: { stab: 10, eco: -20 } },
                no: { desc: "Pragmatismo diplomático.", effect: { eco: 5 } }
            },
            {
                text: "Subsidiar combustível para caminhoneiros?",
                yes: { desc: "Evita greve imediata, rombo no orçamento.", effect: { stab: 10, eco: -15 } },
                no: { desc: "Risco de paralisação no país.", effect: { eco: 10, stab: -15 } }
            }
        ];

        // --- GAME STATE ---
        const Game = {
            state: {
                roomCode: null,
                myId: null,
                isHost: false,
                round: 1,
                phase: 'action', 
                players: [], 
                newsFeed: [],
                alliances: []
            },

            // --- LOBBY & INIT ---
            
            createRoom: (name) => {
                const code = Math.random().toString(36).substring(2,6).toUpperCase();
                const myId = 'p' + Date.now();
                
                Game.state.roomCode = code;
                Game.state.myId = myId;
                Game.state.isHost = true;
                
                // Add Host
                Game.state.players = [Game.createPlayerStruct(myId, name)];
                
                Game.save();
                router.navigate('lobby');
            },

            joinRoom: (name, code) => {
                // Mock logic: In a real app this would verify with server.
                // Here we just "simulate" joining successfully if code is 4 chars
                if(code.length !== 4) return showToast("Código inválido", 'error');

                const myId = 'p' + Date.now();
                Game.state.roomCode = code.toUpperCase();
                Game.state.myId = myId;
                Game.state.isHost = false;

                // Simulate finding the host (if local testing reset)
                // For "1 person testing", we just reset players and add self.
                Game.state.players = [Game.createPlayerStruct(myId, name)];

                Game.save();
                router.navigate('lobby');
            },

            createPlayerStruct: (id, name) => {
                return {
                    id, name, 
                    isHuman: true,
                    country: null,
                    style: null,
                    stats: { eco: 50, stab: 50, pop: 50 },
                    visibility: 'public',
                    hasActed: false,
                    visibilityChangedThisRound: false
                };
            },

            startMatch: () => {
                // Assign Countries randomly
                const shuffledCountries = [...COUNTRIES].sort(() => 0.5 - Math.random());
                Game.state.players.forEach((p, i) => {
                    p.country = shuffledCountries[i % shuffledCountries.length];
                });

                Game.save();
                router.navigate('country');
                Game.showGovernmentSelection();
            },

            // --- GAMEPLAY ---

            getMyPlayer: () => Game.state.players.find(p => p.id === Game.state.myId),

            showGovernmentSelection: () => {
                const me = Game.getMyPlayer();
                const overlay = document.getElementById('setup-overlay');
                const optionsContainer = document.getElementById('setup-options');
                
                const options = [...ALL_GOV_STYLES].sort(() => 0.5 - Math.random()).slice(0, 4);
                const prep = ['Argentina', 'Colômbia', 'Venezuela'].includes(me.country.name) ? 'da' : 'do';

                document.getElementById('setup-country-pre').innerText = prep;
                document.getElementById('setup-country-name').innerText = me.country.name;

                optionsContainer.innerHTML = options.map(opt => `
                    <button onclick="Game.confirmGovernment('${opt.id}')" class="gov-card w-full bg-slate-800 border border-slate-600 hover:border-gold-500 rounded-xl p-4 text-left group relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-white/5 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-150"></div>
                        <h3 class="text-gold-500 font-black uppercase text-sm mb-1 group-hover:text-white transition-colors">${opt.name}</h3>
                        <p class="text-slate-300 text-xs leading-relaxed">${opt.desc}</p>
                        <div class="flex gap-2 mt-3">
                            ${Object.entries(opt.bonus).map(([k, v]) => `
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded ${v > 0 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
                                    ${k.toUpperCase()} ${v > 0 ? '+' : ''}${v}
                                </span>
                            `).join('')}
                        </div>
                    </button>
                `).join('');

                overlay.classList.remove('hidden');
            },

            confirmGovernment: (styleId) => {
                const me = Game.getMyPlayer();
                const style = ALL_GOV_STYLES.find(s => s.id === styleId);
                
                me.style = style;
                
                if (style.bonus.eco) me.stats.eco += style.bonus.eco;
                if (style.bonus.pop) me.stats.pop += style.bonus.pop;
                if (style.bonus.stab) me.stats.stab += style.bonus.stab;

                ['eco','pop','stab'].forEach(k => me.stats[k] = Math.max(0, Math.min(100, me.stats[k])));

                Game.save();
                document.getElementById('setup-overlay').classList.add('hidden');
                
                Game.generateTurnEvents();
                router.renderCurrent();
                showToast(`Governo ${style.name} iniciado!`);
            },

            toggleVisibility: () => {
                const me = Game.getMyPlayer();
                
                if (me.visibilityChangedThisRound) {
                    return showToast("Visibilidade já alterada neste semestre!", "error");
                }

                me.visibility = me.visibility === 'public' ? 'anon' : 'public';
                me.visibilityChangedThisRound = true;
                
                if (me.visibility === 'anon') {
                    if (me.style.id === 'shadow') {
                        showToast('Dados ocultos. Sem penalidade (Autoritarismo).');
                    } else {
                        me.stats.pop -= 5;
                        Game.addNews(`Rumores indicam falta de transparência no governo de ${me.country.name}.`, 'real');
                        showToast('Popularidade oculta (-5 Pop)', 'warning');
                    }
                } else {
                    showToast('Dados públicos novamente');
                }
                Game.save();
                router.renderCurrent();
            },

            generateTurnEvents: () => {
                const me = Game.getMyPlayer();
                me.currentDilemma = DECISIONS_POOL[Math.floor(Math.random() * DECISIONS_POOL.length)];
                document.getElementById('badge-decision').classList.remove('hidden');
                Game.save();
            },

            resolveDilemma: (choiceIndex) => { // 0 = Yes, 1 = No
                const me = Game.getMyPlayer();
                if (!me.currentDilemma) return;

                const decision = me.currentDilemma;
                const outcome = choiceIndex === 0 ? decision.yes : decision.no;

                // Apply effects
                if (outcome.effect.eco) me.stats.eco += outcome.effect.eco;
                if (outcome.effect.pop) me.stats.pop += outcome.effect.pop;
                if (outcome.effect.stab) me.stats.stab += outcome.effect.stab;

                // Clamp
                ['eco','pop','stab'].forEach(k => me.stats[k] = Math.max(0, Math.min(100, me.stats[k])));

                // News
                const actionText = choiceIndex === 0 ? "aprovou" : "rejeitou";
                Game.addNews(`${me.country.name} ${actionText} medida: ${decision.text}`, 'real');
                
                me.currentDilemma = null;
                me.hasActed = true;
                document.getElementById('badge-decision').classList.add('hidden');
                
                Game.save();
                router.renderCurrent(); // Will show waiting screen

                // Simulate Waiting for others (Since 1 player limit, just short delay)
                setTimeout(() => {
                    Game.nextRound();
                }, 2000);
            },

            nextRound: () => {
                Game.state.round++;
                const me = Game.getMyPlayer();
                
                // Reset per-round flags
                me.hasActed = false;
                me.visibilityChangedThisRound = false;

                if (Game.state.round === 4 || Game.state.round === 8) {
                    Game.startDebate();
                } else {
                    Game.generateTurnEvents();
                    showToast(`Início do Semestre ${Game.state.round}`);
                }
                Game.save();
                router.renderCurrent();
            },

            // ... (Rest of logic: Spy, News, Debate same as before) ...
            createFakeNews: (targetId, headline) => {
                const me = Game.getMyPlayer();
                const target = Game.state.players.find(p => p.id === targetId);
                Game.addNews(`Vazamento: ${headline} em ${target.country.name}!`, 'fake', me.id);
                showToast('Fake News plantada!');
                closeModal();
            },

            deploySpy: (targetId, sector) => { 
                const target = Game.state.players.find(p => p.id === targetId);
                if (Math.random() > 0.5) {
                    const stolenInfo = `Popularidade real de ${target.country.name}: ${target.stats.pop}%`;
                    alert(`Espião Sucesso!\n${stolenInfo}`);
                } else {
                    alert('Espião falhou e foi capturado!');
                    Game.addNews(`Espião estrangeiro capturado na capital de ${target.country.name}!`, 'real');
                    target.stats.stab -= 5;
                }
                closeModal();
            },

            addNews: (text, type, sourceId = null) => {
                Game.state.newsFeed.unshift({ 
                    id: Date.now(), text, type, sourceId, round: Game.state.round 
                });
                document.getElementById('badge-news').classList.remove('hidden');
                Game.save();
            },

            startDebate: () => {
                document.getElementById('debate-overlay').classList.remove('hidden');
                Game.debateQueue = [...Game.state.players];
                Game.debateNextSpeaker();
            },

            debateNextSpeaker: () => {
                if (Game.debateQueue.length === 0) {
                    document.getElementById('debate-overlay').classList.add('hidden');
                    showToast('Fim do Debate Continental!');
                    Game.generateTurnEvents();
                    return;
                }
                const speaker = Game.debateQueue.shift();
                const isMe = speaker.id === Game.state.myId;
                
                document.getElementById('debate-speaker-name').innerText = speaker.country.name;
                document.getElementById('debate-speaker-name').className = `text-3xl font-bold mb-4 ${isMe ? 'text-gold-400' : 'text-slate-400'}`;
                
                const btnEnd = document.getElementById('btn-end-speech');
                const waitMsg = document.getElementById('debate-wait-msg');
                const timerBar = document.getElementById('debate-timer-bar');
                const countdown = document.getElementById('debate-countdown');

                if (isMe) {
                    btnEnd.classList.remove('hidden');
                    waitMsg.classList.add('hidden');
                    document.getElementById('debate-topic').innerText = "Sua vez! Defenda seu governo ou ataque.";
                } else {
                    btnEnd.classList.add('hidden');
                    waitMsg.classList.remove('hidden');
                    document.getElementById('debate-topic').innerText = `${speaker.name} está discursando...`;
                }

                let time = 30;
                countdown.innerText = time;
                timerBar.style.width = '100%';
                if (Game.debateInterval) clearInterval(Game.debateInterval);
                Game.debateInterval = setInterval(() => {
                    time--;
                    countdown.innerText = time;
                    timerBar.style.width = `${(time/30)*100}%`;
                    if (time <= 0) Game.endSpeech();
                }, 1000);
            },

            endSpeech: () => {
                clearInterval(Game.debateInterval);
                Game.debateNextSpeaker();
            },
            
            save: () => { localStorage.setItem('presidentes_game', JSON.stringify(Game.state)); Game.renderHeader(); },
            load: () => { 
                const data = localStorage.getItem('presidentes_game'); 
                if(data) { Game.state = JSON.parse(data); Game.renderHeader(); return true; } 
                return false; 
            },
            renderHeader: () => {
                const me = Game.getMyPlayer();
                if (me && me.country) {
                    document.getElementById('header-country').innerText = me.country.name;
                    document.getElementById('round-display').innerText = `${Game.state.round}/8`;
                    document.getElementById('game-header').classList.remove('hidden');
                    document.getElementById('game-nav').classList.remove('hidden');
                } else {
                    document.getElementById('game-header').classList.add('hidden');
                    document.getElementById('game-nav').classList.add('hidden');
                }
            }
        };

        // --- ROUTER ---
        const router = {
            current: 'home',
            navigate: (view) => {
                router.current = view;
                Game.renderHeader();
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn.onclick.toString().includes(view)) {
                        btn.classList.remove('opacity-60'); btn.classList.add('text-gold-500');
                    } else {
                        btn.classList.add('opacity-60'); btn.classList.remove('text-gold-500');
                    }
                });
                router.renderCurrent();
            },
            renderCurrent: () => {
                const container = document.getElementById('app-container');
                container.innerHTML = '';
                
                // Allow home and lobby without player country/style
                if (['home','lobby'].includes(router.current)) {
                     if(router.current === 'home') renderHome(container);
                     if(router.current === 'lobby') renderLobby(container);
                     lucide.createIcons();
                     return;
                }

                if (!Game.getMyPlayer()) { router.navigate('home'); return; }

                switch(router.current) {
                    case 'country': renderCountry(container); break;
                    case 'map': renderMap(container); break;
                    case 'decisions': renderDecisions(container); break;
                    case 'relations': renderRelations(container); break;
                    case 'news': renderNews(container); break;
                }
                lucide.createIcons();
            }
        };

        // --- VIEWS ---

        function renderHome(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center p-6 bg-dark-900 animate-fade-in">
                    <div class="mb-10 text-center">
                        <i data-lucide="globe-2" class="w-20 h-20 text-gold-500 mx-auto mb-4"></i>
                        <h1 class="text-3xl font-black text-white tracking-widest uppercase">Presidentes<br><span class="text-gold-500">América do Sul</span></h1>
                        <p class="text-slate-400 mt-2 text-sm">Política. Estratégia. Traição.</p>
                    </div>
                    
                    <div class="w-full max-w-xs space-y-6">
                        <input type="text" id="player-name" placeholder="Seu Nome" class="w-full bg-slate-800 border border-slate-600 text-white p-4 rounded-xl focus:border-gold-500 outline-none transition-colors">
                        
                        <div class="space-y-3">
                            <button onclick="handleCreateRoom()" class="w-full bg-gold-500 hover:bg-gold-400 text-dark-900 font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Criar Sala
                            </button>
                            <div class="flex gap-2">
                                <input type="text" id="room-code-input" placeholder="Cód." class="w-24 bg-slate-800 border border-slate-600 text-white p-4 rounded-xl text-center uppercase font-mono tracking-widest">
                                <button onclick="handleJoinRoom()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all">
                                    Entrar
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="absolute bottom-6 text-xs text-slate-600">v2.1 Online Logic</p>
                </div>
            `;
        }

        function handleCreateRoom() {
            const name = document.getElementById('player-name').value;
            if(!name) return showToast('Digite um nome!');
            Game.createRoom(name);
        }

        function handleJoinRoom() {
            const name = document.getElementById('player-name').value;
            const code = document.getElementById('room-code-input').value;
            if(!name) return showToast('Digite um nome!');
            if(!code) return showToast('Digite o código!');
            Game.joinRoom(name, code);
        }

        function renderLobby(container) {
            container.innerHTML = `
                <div class="h-full flex flex-col p-6 bg-dark-900 animate-slide-up">
                    <div class="text-center mb-8 mt-10">
                        <p class="text-slate-400 text-sm uppercase">Código da Sala</p>
                        <h1 class="text-6xl font-mono text-white tracking-widest my-2 select-all">${Game.state.roomCode}</h1>
                        <p class="text-slate-500 text-xs">Compartilhe este código com seus amigos</p>
                    </div>

                    <div class="flex-1 bg-slate-800/50 rounded-2xl p-4 border border-slate-700 mb-6">
                        <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-4 h-4 text-gold-500"></i> Jogadores (${Game.state.players.length}/1)
                        </h3>
                        <div class="space-y-2">
                            ${Game.state.players.map(p => `
                                <div class="bg-slate-700 p-3 rounded-xl flex items-center gap-3">
                                    <div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="w-4 h-4 text-white"></i>
                                    </div>
                                    <span class="text-white font-bold">${p.name}</span>
                                    ${p.id === Game.state.myId ? '<span class="text-xs bg-gold-500 text-dark-900 px-2 rounded font-bold">VOCÊ</span>' : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${Game.state.isHost ? `
                        <button onclick="Game.startMatch()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-5 h-5"></i> Iniciar Jogo
                        </button>
                    ` : `
                        <p class="text-center text-slate-400 animate-pulse">Aguardando o anfitrião iniciar...</p>
                    `}
                </div>
            `;
        }

        function renderDecisions(container) {
            const me = Game.getMyPlayer();

            // Waiting State
            if (me.hasActed) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center p-6 text-center animate-fade-in">
                        <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 relative">
                            <i data-lucide="hourglass" class="w-10 h-10 text-gold-500 animate-pulse-slow"></i>
                            <div class="absolute inset-0 border-4 border-gold-500/30 rounded-full animate-ping"></div>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Aguardando Líderes</h2>
                        <p class="text-slate-400 max-w-xs mx-auto">Suas ordens foram enviadas. Espere os outros presidentes tomarem suas decisões para avançar o semestre.</p>
                        
                        <div class="mt-8 p-4 bg-slate-800 rounded-xl border border-slate-700 w-full max-w-xs">
                            <div class="flex justify-between text-xs text-slate-400 mb-1">
                                <span>Progresso Global</span>
                                <span>100% (Simulado)</span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-green-500 w-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Decision State
            if (me.currentDilemma) {
                const d = me.currentDilemma;
                container.innerHTML = `
                    <div class="p-6 space-y-6 animate-fade-in pb-24">
                        <h2 class="text-2xl font-bold text-white mb-2">Gabinete Presidencial</h2>
                        
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 border border-gold-500/50 rounded-2xl p-1 shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gold-500 z-10"></div>
                            <div class="p-5">
                                <h3 class="text-gold-500 font-bold text-xs uppercase mb-2 tracking-wider">Decisão Obrigatória</h3>
                                <p class="text-lg text-white font-bold leading-relaxed mb-6">${d.text}</p>
                                
                                <div class="space-y-3">
                                    <!-- Approve Card -->
                                    <button onclick="Game.resolveDilemma(0)" class="w-full bg-green-900/30 border border-green-700/50 hover:bg-green-900/50 hover:border-green-500 rounded-xl p-3 text-left group transition-all active:scale-95">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-green-400 font-bold uppercase text-sm">Aprovar</span>
                                            <i data-lucide="check-circle" class="w-4 h-4 text-green-500 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                        </div>
                                        <p class="text-slate-300 text-xs mb-2">${d.yes.desc}</p>
                                        <div class="flex gap-2">
                                            ${Object.entries(d.yes.effect).map(([k,v]) => 
                                                `<span class="text-[10px] px-1.5 rounded bg-black/40 ${v>0?'text-green-300':'text-red-300'} font-mono">${k.toUpperCase()} ${v>0?'+':''}${v}</span>`
                                            ).join('')}
                                        </div>
                                    </button>

                                    <!-- Veto Card -->
                                    <button onclick="Game.resolveDilemma(1)" class="w-full bg-red-900/30 border border-red-700/50 hover:bg-red-900/50 hover:border-red-500 rounded-xl p-3 text-left group transition-all active:scale-95">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-red-400 font-bold uppercase text-sm">Vetar</span>
                                            <i data-lucide="x-circle" class="w-4 h-4 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                        </div>
                                        <p class="text-slate-300 text-xs mb-2">${d.no.desc}</p>
                                        <div class="flex gap-2">
                                            ${Object.entries(d.no.effect).map(([k,v]) => 
                                                `<span class="text-[10px] px-1.5 rounded bg-black/40 ${v>0?'text-green-300':'text-red-300'} font-mono">${k.toUpperCase()} ${v>0?'+':''}${v}</span>`
                                            ).join('')}
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-sm font-bold text-slate-400 uppercase mb-3">Ações Especiais</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="bg-dark-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center gap-2 active:bg-slate-700" onclick="alert('Use o Mapa para selecionar um alvo.')">
                                    <i data-lucide="eye" class="text-red-400"></i>
                                    <span class="text-sm font-bold text-white">Espionagem</span>
                                </button>
                                <button class="bg-dark-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center gap-2 active:bg-slate-700" onclick="alert('Use o Mapa para selecionar um alvo.')">
                                    <i data-lucide="file-warning" class="text-purple-400"></i>
                                    <span class="text-sm font-bold text-white">Gabinete do Ódio</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                 container.innerHTML = `
                    <div class="bg-slate-800/50 border border-slate-700 border-dashed rounded-2xl p-8 text-center m-6">
                        <i data-lucide="check-circle" class="w-12 h-12 text-slate-500 mx-auto mb-2"></i>
                        <p class="text-slate-400">Nenhuma pendência urgente.</p>
                    </div>
                `;
            }
        }

        // Functions for other views (Country, Map, Relations, News) remain largely same but updated with standard Game.state check
        function renderCountry(container) {
            const me = Game.getMyPlayer();
            if (!me || !me.style) return;

            container.innerHTML = `
                <div class="p-6 space-y-6 animate-slide-up">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-white">${me.country.name}</h2>
                                <p class="text-gold-500 text-sm font-bold uppercase">${me.style.name}</p>
                            </div>
                            <div class="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center">
                                <i data-lucide="flag" class="w-6 h-6 text-white"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="text-center"><div class="text-xs text-slate-400 uppercase font-bold mb-1">Economia</div><div class="text-xl font-bold text-green-400">${me.stats.eco}%</div></div>
                            <div class="text-center border-x border-slate-700"><div class="text-xs text-slate-400 uppercase font-bold mb-1">Estab.</div><div class="text-xl font-bold text-blue-400">${me.stats.stab}%</div></div>
                            <div class="text-center"><div class="text-xs text-slate-400 uppercase font-bold mb-1">Popularidade</div><div class="text-xl font-bold text-gold-500">${me.stats.pop}%</div></div>
                        </div>
                        <button onclick="Game.toggleVisibility()" class="w-full flex items-center justify-between bg-slate-700/50 p-3 rounded-xl border border-slate-600 active:bg-slate-700 transition-colors ${me.visibilityChangedThisRound ? 'opacity-50 cursor-not-allowed' : ''}">
                            <div class="flex items-center gap-3">
                                <i data-lucide="${me.visibility === 'public' ? 'eye' : 'eye-off'}" class="w-5 h-5 ${me.visibility === 'public' ? 'text-green-400' : 'text-red-400'}"></i>
                                <div class="text-left">
                                    <div class="text-sm font-bold text-white">Dados ${me.visibility === 'public' ? 'Públicos' : 'Anônimos'}</div>
                                    <div class="text-[10px] text-slate-400">${me.visibilityChangedThisRound ? 'Aguarde próximo semestre' : 'Clique para alterar'}</div>
                                </div>
                            </div>
                            <div class="w-2 h-2 rounded-full ${me.visibility === 'public' ? 'bg-green-500' : 'bg-red-500'}"></div>
                        </button>
                    </div>
                </div>
            `;
        }

        // Map, Relations, News render functions kept as is, just ensured they use Game.getMyPlayer correctly.
        function renderMap(container) {
             container.innerHTML = `
                <div class="h-full flex flex-col bg-[#1e293b] animate-fade-in relative">
                    <h2 class="absolute top-4 left-6 text-2xl font-black text-white/10 z-0">AMÉRICA<br>DO SUL</h2>
                    <div class="flex-1 flex items-center justify-center p-4 z-10">
                        <svg viewBox="0 0 240 450" class="w-full h-full drop-shadow-2xl">
                            ${COUNTRIES.map(c => {
                                const owner = Game.state.players.find(p => p.country && p.country.id === c.id);
                                const fillColor = owner ? '#EAB308' : '#334155';
                                const strokeColor = owner ? '#FEF08A' : '#475569';
                                return `<path id="map-${c.id}" d="${c.path}" class="country-path" style="fill: ${fillColor}; stroke: ${strokeColor};" onclick="openCountryDetails('${c.id}')" />`;
                            }).join('')}
                        </svg>
                    </div>
                </div>
            `;
        }
        function renderRelations(container) {
             container.innerHTML = `<div class="p-6 space-y-4 animate-fade-in pb-24"><h2 class="text-2xl font-bold text-white mb-4">Relações Exteriores</h2><div class="space-y-2">${Game.state.players.map(p => `<div class="bg-dark-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center font-bold text-white text-xs border border-slate-500">${p.country ? p.country.id.toUpperCase() : '??'}</div><div><div class="font-bold text-white">${p.country ? p.country.name : 'Selecionando...'}</div><div class="text-xs text-slate-400">${p.style ? p.style.name : '...'}</div></div></div></div>`).join('')}</div></div>`;
        }
        function renderNews(container) {
            const me = Game.getMyPlayer();
            const feed = Game.state.newsFeed.map(n => {
                let displayType = 'real';
                if (n.type === 'fake') displayType = (n.sourceId === me.id) ? 'fake' : 'real'; 
                return { ...n, displayType };
            });
            document.getElementById('badge-news').classList.add('hidden');
            container.innerHTML = `<div class="p-6 animate-fade-in pb-24"><h2 class="text-2xl font-bold text-white mb-6">Central de Notícias</h2><div class="space-y-4">${feed.map(n => `<div class="bg-dark-800 p-4 rounded-r-xl news-item news-${n.displayType}"><div class="flex justify-between items-start mb-1"><span class="text-[10px] font-bold uppercase text-slate-400">Semestre ${n.round}</span>${n.displayType === 'fake' ? '<span class="text-[10px] bg-purple-900 text-purple-300 px-2 rounded">SEU FAKE</span>' : ''}</div><p class="text-sm text-slate-200 leading-snug">${n.text}</p></div>`).join('')}${feed.length === 0 ? '<p class="text-center text-slate-500 mt-10">Nenhuma notícia recente.</p>' : ''}</div></div>`;
        }
        function openCountryDetails(id) { /* Existing logic */ 
             const target = Game.state.players.find(p => p.country && p.country.id === id);
             const modal = document.getElementById('modal-overlay');
             const content = document.getElementById('modal-content');
             modal.classList.remove('hidden');
             if (!target) { content.innerHTML = `<h3 class="text-white font-bold">País Neutro</h3><button onclick="closeModal()" class="mt-4 w-full py-2 bg-slate-700 text-white rounded">Fechar</button>`; return; }
             const isPublic = target.visibility === 'public';
             content.innerHTML = `<div class="text-center mb-6"><h2 class="text-2xl font-bold text-white mb-1">${target.country.name}</h2><p class="text-gold-500 text-xs font-bold uppercase">${target.name}</p></div><div class="bg-slate-900/50 p-4 rounded-xl mb-4 border border-slate-700"><div class="flex justify-between items-center mb-2"><span class="text-slate-400 text-sm">Popularidade</span><span class="text-white font-bold">${isPublic ? target.stats.pop + '%' : '???'}</span></div></div><div class="grid grid-cols-2 gap-2"><button onclick="Game.deploySpy('${target.id}','gov')" class="bg-red-900/50 py-3 text-red-100 rounded text-xs font-bold">Espionar</button><button onclick="openFakeNewsMenu('${target.id}')" class="bg-purple-900/50 py-3 text-purple-100 rounded text-xs font-bold">Fake News</button></div><button onclick="closeModal()" class="mt-4 w-full text-slate-400 text-sm">Fechar</button>`;
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            if (Game.load()) {
                if(Game.state.myId) {
                    const me = Game.getMyPlayer();
                    if(!me.country) router.navigate('lobby');
                    else {
                         router.navigate('country');
                         if (!me.style) Game.showGovernmentSelection();
                    }
                } else router.navigate('home');
            } else {
                router.navigate('home');
            }
        });
    </script>
</body>
</html>